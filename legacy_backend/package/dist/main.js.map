{"version":3,"sources":["../src/main.ts"],"sourcesContent":["import * as p from '@clack/prompts'\nimport slugify from '@sindresorhus/slugify'\nimport arg from 'arg'\nimport chalk from 'chalk'\nimport figures from 'figures'\nimport path from 'path'\n\nimport type { CliArgs } from './types.js'\n\nimport { configurePayloadConfig } from './lib/configure-payload-config.js'\nimport { createProject } from './lib/create-project.js'\nimport { parseExample } from './lib/examples.js'\nimport { generateSecret } from './lib/generate-secret.js'\nimport { getPackageManager } from './lib/get-package-manager.js'\nimport { getNextAppDetails, initNext } from './lib/init-next.js'\nimport { manageEnvFiles } from './lib/manage-env-files.js'\nimport { parseProjectName } from './lib/parse-project-name.js'\nimport { parseTemplate } from './lib/parse-template.js'\nimport { selectDb } from './lib/select-db.js'\nimport { getValidTemplates, validateTemplate } from './lib/templates.js'\nimport { updatePayloadInProject } from './lib/update-payload-in-project.js'\nimport { getLatestPackageVersion } from './utils/getLatestPackageVersion.js'\nimport { debug, error, info } from './utils/log.js'\nimport {\n  feedbackOutro,\n  helpMessage,\n  moveMessage,\n  successfulNextInit,\n  successMessage,\n} from './utils/messages.js'\n\nexport class Main {\n  args: CliArgs\n\n  constructor() {\n    // @ts-expect-error bad typings\n    this.args = arg(\n      {\n        '--branch': String,\n        '--db': String,\n        '--db-accept-recommended': Boolean,\n        '--db-connection-string': String,\n        '--example': String,\n        '--help': Boolean,\n        '--local-template': String,\n        '--name': String,\n        '--secret': String,\n        '--template': String,\n        '--version': String, // Allows overriding the installed Payload version instead of installing the latest\n\n        // Next.js\n        '--init-next': Boolean, // TODO: Is this needed if we detect if inside Next.js project?\n\n        // Package manager\n        '--no-deps': Boolean,\n        '--use-bun': Boolean,\n        '--use-npm': Boolean,\n        '--use-pnpm': Boolean,\n        '--use-yarn': Boolean,\n\n        // Other\n        '--no-git': Boolean,\n\n        // Flags\n        '--beta': Boolean,\n        '--debug': Boolean,\n        '--dry-run': Boolean,\n\n        // Aliases\n        '-d': '--db',\n        '-e': '--example',\n        '-h': '--help',\n        '-n': '--name',\n        '-t': '--template',\n      },\n      { permissive: true },\n    )\n  }\n\n  async init(): Promise<void> {\n    try {\n      const debugFlag = this.args['--debug']\n\n      const LATEST_VERSION = await getLatestPackageVersion({\n        debug: debugFlag,\n        packageName: 'payload',\n      })\n\n      if (this.args['--help']) {\n        helpMessage()\n        process.exit(0)\n      }\n\n      // eslint-disable-next-line no-console\n      console.log('\\n')\n      p.intro(chalk.bgCyan(chalk.black(' create-payload-app ')))\n      p.note(\"Welcome to Payload. Let's create a project!\")\n\n      // Detect if inside Next.js project\n      const nextAppDetails = await getNextAppDetails(process.cwd())\n      const {\n        hasTopLevelLayout,\n        isPayloadInstalled,\n        isSupportedNextVersion,\n        nextAppDir,\n        nextConfigPath,\n        nextVersion,\n      } = nextAppDetails\n\n      if (nextConfigPath && !isSupportedNextVersion) {\n        p.log.warn(\n          `Next.js v${nextVersion} is unsupported. Next.js >= 15 is required to use Payload.`,\n        )\n        p.outro(feedbackOutro())\n        process.exit(0)\n      }\n\n      // Upgrade Payload in existing project\n      if (isPayloadInstalled && nextConfigPath) {\n        p.log.warn(`Payload installation detected in current project.`)\n        const shouldUpdate = await p.confirm({\n          initialValue: false,\n          message: chalk.bold(`Upgrade Payload in this project?`),\n        })\n\n        if (!p.isCancel(shouldUpdate) && shouldUpdate) {\n          const { message, success: updateSuccess } = await updatePayloadInProject(nextAppDetails)\n          if (updateSuccess) {\n            info(message)\n          } else {\n            error(message)\n          }\n        }\n\n        p.outro(feedbackOutro())\n        process.exit(0)\n      }\n\n      if (nextConfigPath) {\n        this.args['--name'] = slugify(path.basename(path.dirname(nextConfigPath)))\n      }\n\n      const projectName = await parseProjectName(this.args)\n      const projectDir = nextConfigPath\n        ? path.dirname(nextConfigPath)\n        : path.resolve(process.cwd(), slugify(projectName))\n\n      const packageManager = await getPackageManager({ cliArgs: this.args, projectDir })\n\n      if (nextConfigPath) {\n        p.log.step(\n          chalk.bold(`${chalk.bgBlack(` ${figures.triangleUp} Next.js `)} project detected!`),\n        )\n\n        const proceed = await p.confirm({\n          initialValue: true,\n          message: chalk.bold(`Install ${chalk.green('Payload')} in this project?`),\n        })\n        if (p.isCancel(proceed) || !proceed) {\n          p.outro(feedbackOutro())\n          process.exit(0)\n        }\n\n        // Check for top-level layout.tsx\n        if (nextAppDir && hasTopLevelLayout) {\n          p.log.warn(moveMessage({ nextAppDir, projectDir }))\n          p.outro(feedbackOutro())\n          process.exit(0)\n        }\n\n        const dbDetails = await selectDb(this.args, projectName)\n\n        const result = await initNext({\n          ...this.args,\n          dbType: dbDetails.type,\n          nextAppDetails,\n          packageManager,\n          projectDir,\n        })\n\n        if (result.success === false) {\n          p.outro(feedbackOutro())\n          process.exit(1)\n        }\n\n        await configurePayloadConfig({\n          dbType: dbDetails?.type,\n          projectDirOrConfigPath: {\n            payloadConfigPath: result.payloadConfigPath,\n          },\n        })\n\n        await manageEnvFiles({\n          cliArgs: this.args,\n          databaseType: dbDetails.type,\n          databaseUri: dbDetails.dbUri,\n          payloadSecret: generateSecret(),\n          projectDir,\n        })\n\n        info('Payload project successfully initialized!')\n        p.note(successfulNextInit(), chalk.bgGreen(chalk.black(' Documentation ')))\n        p.outro(feedbackOutro())\n        return\n      }\n\n      const templateArg = this.args['--template']\n      if (templateArg) {\n        const valid = validateTemplate({ templateName: templateArg })\n        if (!valid) {\n          helpMessage()\n          process.exit(1)\n        }\n      }\n\n      const exampleArg = this.args['--example']\n\n      if (exampleArg) {\n        const example = await parseExample({\n          name: exampleArg,\n          branch: this.args['--branch'] ?? 'main',\n        })\n\n        if (!example) {\n          helpMessage()\n          process.exit(1)\n        }\n\n        await createProject({\n          cliArgs: this.args,\n          example,\n          packageManager,\n          projectDir,\n          projectName,\n        })\n      }\n\n      if (debugFlag) {\n        debug(`Using ${exampleArg ? 'examples' : 'templates'} from git tag: v${LATEST_VERSION}`)\n      }\n\n      if (!exampleArg) {\n        const validTemplates = getValidTemplates()\n        const template = await parseTemplate(this.args, validTemplates)\n        if (!template) {\n          p.log.error('Invalid template given')\n          p.outro(feedbackOutro())\n          process.exit(1)\n        }\n\n        switch (template.type) {\n          case 'plugin': {\n            await createProject({\n              cliArgs: this.args,\n              packageManager,\n              projectDir,\n              projectName,\n              template,\n            })\n            break\n          }\n          case 'starter': {\n            const dbDetails = await selectDb(this.args, projectName)\n\n            await createProject({\n              cliArgs: this.args,\n              dbDetails,\n              packageManager,\n              projectDir,\n              projectName,\n              template,\n            })\n\n            break\n          }\n        }\n      }\n\n      info('Payload project successfully created!')\n      p.log.step(chalk.bgGreen(chalk.black(' Next Steps ')))\n      p.log.message(successMessage(projectDir, packageManager))\n      p.outro(feedbackOutro())\n    } catch (err: unknown) {\n      error(err instanceof Error ? err.message : 'An error occurred')\n    }\n  }\n}\n"],"names":["p","slugify","arg","chalk","figures","path","configurePayloadConfig","createProject","parseExample","generateSecret","getPackageManager","getNextAppDetails","initNext","manageEnvFiles","parseProjectName","parseTemplate","selectDb","getValidTemplates","validateTemplate","updatePayloadInProject","getLatestPackageVersion","debug","error","info","feedbackOutro","helpMessage","moveMessage","successfulNextInit","successMessage","Main","args","constructor","String","Boolean","permissive","init","debugFlag","LATEST_VERSION","packageName","process","exit","console","log","intro","bgCyan","black","note","nextAppDetails","cwd","hasTopLevelLayout","isPayloadInstalled","isSupportedNextVersion","nextAppDir","nextConfigPath","nextVersion","warn","outro","shouldUpdate","confirm","initialValue","message","bold","isCancel","success","updateSuccess","basename","dirname","projectName","projectDir","resolve","packageManager","cliArgs","step","bgBlack","triangleUp","proceed","green","dbDetails","result","dbType","type","projectDirOrConfigPath","payloadConfigPath","databaseType","databaseUri","dbUri","payloadSecret","bgGreen","templateArg","valid","templateName","exampleArg","example","name","branch","validTemplates","template","err","Error"],"mappings":"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"}