{"version":3,"sources":["../../src/lib/manage-env-files.spec.ts"],"sourcesContent":["import { jest } from '@jest/globals'\nimport fs from 'fs'\nimport fse from 'fs-extra'\nimport * as os from 'node:os'\nimport path from 'path'\n\nimport type { CliArgs } from '../types.js'\n\nimport { manageEnvFiles } from './manage-env-files.js'\n\ndescribe('createProject', () => {\n  let projectDir: string\n  let envFilePath = ''\n  let envExampleFilePath = ''\n\n  beforeAll(() => {\n    // eslint-disable-next-line no-console\n    console.log = jest.fn()\n  })\n\n  beforeEach(() => {\n    const tempDirectory = fs.realpathSync(os.tmpdir())\n    projectDir = `${tempDirectory}/${Math.random().toString(36).substring(7)}`\n\n    envFilePath = path.join(projectDir, '.env')\n    envExampleFilePath = path.join(projectDir, '.env.example')\n\n    if (fse.existsSync(envFilePath)) {\n      fse.removeSync(envFilePath)\n    }\n\n    fse.ensureDirSync(projectDir)\n  })\n\n  afterEach(() => {\n    if (fse.existsSync(projectDir)) {\n      fse.rmSync(projectDir, { recursive: true })\n    }\n  })\n\n  it('generates .env using defaults (not from .env.example)', async () => {\n    // ensure no .env.example exists so that the default values are used\n    // the `manageEnvFiles` function will look for .env.example in the file system\n    if (fse.existsSync(envExampleFilePath)) {\n      fse.removeSync(envExampleFilePath)\n    }\n\n    await manageEnvFiles({\n      cliArgs: {\n        '--debug': true,\n      } as CliArgs,\n      databaseUri: '', // omitting this will ensure the default vars are used\n      payloadSecret: '', // omitting this will ensure the default vars are used\n      projectDir,\n      template: undefined,\n    })\n\n    expect(fse.existsSync(envFilePath)).toBe(true)\n\n    const updatedEnvContent = fse.readFileSync(envFilePath, 'utf-8')\n\n    expect(updatedEnvContent).toBe(\n      `# Added by Payload\\nPAYLOAD_SECRET=YOUR_SECRET_HERE\\nDATABASE_URI=your-connection-string-here`,\n    )\n  })\n\n  it('generates .env from .env.example', async () => {\n    // create or override the .env.example file with a connection string that will NOT be overridden\n    fse.ensureFileSync(envExampleFilePath)\n    fse.writeFileSync(\n      envExampleFilePath,\n      `DATABASE_URI=example-connection-string\\nCUSTOM_VAR=custom-value\\n`,\n    )\n\n    await manageEnvFiles({\n      cliArgs: {\n        '--debug': true,\n      } as CliArgs,\n      databaseUri: '', // omitting this will ensure the `.env.example` vars are used\n      payloadSecret: '', // omitting this will ensure the `.env.example` vars are used\n      projectDir,\n      template: undefined,\n    })\n\n    expect(fse.existsSync(envFilePath)).toBe(true)\n\n    const updatedEnvContent = fse.readFileSync(envFilePath, 'utf-8')\n\n    expect(updatedEnvContent).toBe(\n      `DATABASE_URI=example-connection-string\\nCUSTOM_VAR=custom-value\\nPAYLOAD_SECRET=YOUR_SECRET_HERE\\n# Added by Payload`,\n    )\n  })\n\n  it('updates existing .env without overriding vars', async () => {\n    // create an existing .env file with some custom variables that should NOT be overridden\n    fse.ensureFileSync(envFilePath)\n    fse.writeFileSync(\n      envFilePath,\n      `CUSTOM_VAR=custom-value\\nDATABASE_URI=example-connection-string\\n`,\n    )\n\n    // create an .env.example file to ensure that its contents DO NOT override existing .env vars\n    fse.ensureFileSync(envExampleFilePath)\n    fse.writeFileSync(\n      envExampleFilePath,\n      `CUSTOM_VAR=custom-value-2\\nDATABASE_URI=example-connection-string-2\\n`,\n    )\n\n    await manageEnvFiles({\n      cliArgs: {\n        '--debug': true,\n      } as CliArgs,\n      databaseUri: '', // omitting this will ensure the `.env` vars are kept\n      payloadSecret: '', // omitting this will ensure the `.env` vars are kept\n      projectDir,\n      template: undefined,\n    })\n\n    expect(fse.existsSync(envFilePath)).toBe(true)\n\n    const updatedEnvContent = fse.readFileSync(envFilePath, 'utf-8')\n\n    expect(updatedEnvContent).toBe(\n      `# Added by Payload\\nPAYLOAD_SECRET=YOUR_SECRET_HERE\\nDATABASE_URI=example-connection-string\\nCUSTOM_VAR=custom-value`,\n    )\n  })\n\n  it('sanitizes .env based on selected database type', async () => {\n    await manageEnvFiles({\n      cliArgs: {\n        '--debug': true,\n      } as CliArgs,\n      databaseType: 'mongodb', // this mimics the CLI selection and will be used as the DATABASE_URI\n      databaseUri: 'mongodb://localhost:27017/test', // this mimics the CLI selection and will be used as the DATABASE_URI\n      payloadSecret: 'test-secret', // this mimics the CLI selection and will be used as the PAYLOAD_SECRET\n      projectDir,\n      template: undefined,\n    })\n\n    const updatedEnvContent = fse.readFileSync(envFilePath, 'utf-8')\n\n    expect(updatedEnvContent).toBe(\n      `# Added by Payload\\nPAYLOAD_SECRET=test-secret\\nDATABASE_URI=mongodb://localhost:27017/test`,\n    )\n\n    // delete the generated .env file and do it again, but this time, omit the databaseUri to ensure the default is generated\n    fse.removeSync(envFilePath)\n\n    await manageEnvFiles({\n      cliArgs: {\n        '--debug': true,\n      } as CliArgs,\n      databaseType: 'mongodb', // this mimics the CLI selection and will be used as the DATABASE_URI\n      databaseUri: '', // omit this to ensure the default is generated based on the selected database type\n      payloadSecret: 'test-secret',\n      projectDir,\n      template: undefined,\n    })\n\n    const updatedEnvContentWithDefault = fse.readFileSync(envFilePath, 'utf-8')\n    expect(updatedEnvContentWithDefault).toBe(\n      `# Added by Payload\\nPAYLOAD_SECRET=test-secret\\nDATABASE_URI=mongodb://127.0.0.1/your-database-name`,\n    )\n  })\n})\n"],"names":["jest","fs","fse","os","path","manageEnvFiles","describe","projectDir","envFilePath","envExampleFilePath","beforeAll","console","log","fn","beforeEach","tempDirectory","realpathSync","tmpdir","Math","random","toString","substring","join","existsSync","removeSync","ensureDirSync","afterEach","rmSync","recursive","it","cliArgs","databaseUri","payloadSecret","template","undefined","expect","toBe","updatedEnvContent","readFileSync","ensureFileSync","writeFileSync","databaseType","updatedEnvContentWithDefault"],"mappings":"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"}