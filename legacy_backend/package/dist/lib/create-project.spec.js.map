{"version":3,"sources":["../../src/lib/create-project.spec.ts"],"sourcesContent":["import { jest } from '@jest/globals'\nimport fs from 'fs'\nimport fse from 'fs-extra'\nimport globby from 'globby'\nimport * as os from 'node:os'\nimport path from 'path'\n\nimport type { CliArgs, DbType, ProjectExample, ProjectTemplate } from '../types.js'\n\nimport { createProject, updatePackageJSONDependencies } from './create-project.js'\nimport { dbReplacements } from './replacements.js'\nimport { getValidTemplates } from './templates.js'\n\ndescribe('createProject', () => {\n  let projectDir: string\n\n  beforeAll(() => {\n    // eslint-disable-next-line no-console\n    console.log = jest.fn()\n  })\n\n  beforeEach(() => {\n    const tempDirectory = fs.realpathSync(os.tmpdir())\n    projectDir = `${tempDirectory}/${Math.random().toString(36).substring(7)}`\n  })\n\n  afterEach(() => {\n    if (fse.existsSync(projectDir)) {\n      fse.rmSync(projectDir, { recursive: true })\n    }\n  })\n\n  describe('#createProject', () => {\n    const args = {\n      _: ['project-name'],\n      '--db': 'mongodb',\n      '--local-template': 'blank',\n      '--no-deps': true,\n    } as CliArgs\n    const packageManager = 'yarn'\n\n    it('creates plugin template', async () => {\n      const projectName = 'plugin'\n      const template: ProjectTemplate = {\n        name: 'plugin',\n        type: 'plugin',\n        description: 'Template for creating a Payload plugin',\n        url: 'https://github.com/payloadcms/payload/templates/plugin',\n      }\n\n      await createProject({\n        cliArgs: { ...args, '--local-template': 'plugin' } as CliArgs,\n        packageManager,\n        projectDir,\n        projectName,\n        template,\n      })\n\n      const packageJsonPath = path.resolve(projectDir, 'package.json')\n      const packageJson = fse.readJsonSync(packageJsonPath)\n\n      // Check package name and description\n      expect(packageJson.name).toStrictEqual(projectName)\n    })\n\n    it('updates project name in plugin template importMap file', async () => {\n      const projectName = 'my-custom-plugin'\n      const template: ProjectTemplate = {\n        name: 'plugin',\n        type: 'plugin',\n        description: 'Template for creating a Payload plugin',\n        url: 'https://github.com/payloadcms/payload/templates/plugin',\n      }\n\n      await createProject({\n        cliArgs: { ...args, '--local-template': 'plugin' } as CliArgs,\n        packageManager,\n        projectDir,\n        projectName,\n        template,\n      })\n\n      const importMapPath = path.resolve(projectDir, './dev/app/(payload)/admin/importMap.js')\n      const importMapFile = fse.readFileSync(importMapPath, 'utf-8')\n\n      expect(importMapFile).not.toContain('plugin-package-name-placeholder')\n      expect(importMapFile).toContain('my-custom-plugin')\n    })\n\n    it('creates example', async () => {\n      const projectName = 'custom-server-example'\n      const example: ProjectExample = {\n        name: 'custom-server',\n        url: 'https://github.com/payloadcms/payload/examples/custom-server#main',\n      }\n\n      await createProject({\n        cliArgs: {\n          ...args,\n          '--local-template': undefined,\n          '--local-example': 'custom-server',\n        } as CliArgs,\n        packageManager,\n        projectDir,\n        projectName,\n        example,\n      })\n\n      const packageJsonPath = path.resolve(projectDir, 'package.json')\n      const packageJson = fse.readJsonSync(packageJsonPath)\n\n      // Check package name and description\n      expect(packageJson.name).toStrictEqual(projectName)\n    })\n\n    describe('creates project from template', () => {\n      const templates = getValidTemplates()\n\n      it.each([\n        ['blank', 'mongodb'],\n        ['blank', 'postgres'],\n\n        // TODO: Re-enable these once 3.0 is stable and templates updated\n        // ['website', 'mongodb'],\n        // ['website', 'postgres'],\n        // ['ecommerce', 'mongodb'],\n        // ['ecommerce', 'postgres'],\n      ])('update config and deps: %s, %s', async (templateName, db) => {\n        const projectName = 'starter-project'\n\n        const template = templates.find((t) => t.name === templateName)\n\n        const cliArgs = {\n          ...args,\n          '--db': db,\n          '--local-template': templateName,\n        } as CliArgs\n\n        await createProject({\n          cliArgs,\n          dbDetails: {\n            type: db as DbType,\n            dbUri: `${db}://localhost:27017/create-project-test`,\n          },\n          packageManager,\n          projectDir,\n          projectName,\n          template: template as ProjectTemplate,\n        })\n\n        const dbReplacement = dbReplacements[db as DbType]\n\n        const packageJsonPath = path.resolve(projectDir, 'package.json')\n        const packageJson = fse.readJsonSync(packageJsonPath)\n\n        // Verify git was initialized\n        expect(fse.existsSync(path.resolve(projectDir, '.git'))).toBe(true)\n\n        // Should only have one db adapter\n        expect(\n          Object.keys(packageJson.dependencies).filter((n) => n.startsWith('@payloadcms/db-')),\n        ).toHaveLength(1)\n\n        const payloadConfigPath = (\n          await globby('**/payload.config.ts', {\n            absolute: true,\n            cwd: projectDir,\n          })\n        )?.[0]\n\n        const content = fse.readFileSync(payloadConfigPath, 'utf-8')\n\n        // Check payload.config.ts\n        expect(content).not.toContain('// database-adapter-import')\n        expect(content).toContain(dbReplacement.importReplacement)\n\n        expect(content).not.toContain('// database-adapter-config-start')\n        expect(content).not.toContain('// database-adapter-config-end')\n        expect(content).toContain(dbReplacement.configReplacement().join('\\n'))\n      })\n    })\n\n    describe('updates package.json', () => {\n      it('updates package name and bumps workspace versions', async () => {\n        const latestVersion = '3.0.0'\n        const initialJSON = {\n          name: 'test-project',\n          version: '1.0.0',\n          dependencies: {\n            '@payloadcms/db-mongodb': 'workspace:*',\n            payload: 'workspace:*',\n            '@payloadcms/ui': 'workspace:*',\n          },\n        }\n\n        const correctlyModifiedJSON = {\n          name: 'test-project',\n          version: '1.0.0',\n          dependencies: {\n            '@payloadcms/db-mongodb': `${latestVersion}`,\n            payload: `${latestVersion}`,\n            '@payloadcms/ui': `${latestVersion}`,\n          },\n        }\n\n        updatePackageJSONDependencies({\n          latestVersion,\n          packageJson: initialJSON,\n        })\n\n        expect(initialJSON).toEqual(correctlyModifiedJSON)\n      })\n    })\n  })\n})\n"],"names":["jest","fs","fse","globby","os","path","createProject","updatePackageJSONDependencies","dbReplacements","getValidTemplates","describe","projectDir","beforeAll","console","log","fn","beforeEach","tempDirectory","realpathSync","tmpdir","Math","random","toString","substring","afterEach","existsSync","rmSync","recursive","args","_","packageManager","it","projectName","template","name","type","description","url","cliArgs","packageJsonPath","resolve","packageJson","readJsonSync","expect","toStrictEqual","importMapPath","importMapFile","readFileSync","not","toContain","example","undefined","templates","each","templateName","db","find","t","dbDetails","dbUri","dbReplacement","toBe","Object","keys","dependencies","filter","n","startsWith","toHaveLength","payloadConfigPath","absolute","cwd","content","importReplacement","configReplacement","join","latestVersion","initialJSON","version","payload","correctlyModifiedJSON","toEqual"],"mappings":"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"}