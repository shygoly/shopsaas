<!DOCTYPE html>
<html class="dark" lang="en">
<head>
    <meta charset="utf-8"/>
    <meta content="width=device-width, initial-scale=1.0" name="viewport"/>
    <title>ShopSaaS - Manage Your E-commerce Empire</title>
    <script src="https://cdn.tailwindcss.com?plugins=forms,container-queries"></script>
    <link href="https://fonts.googleapis.com" rel="preconnect"/>
    <link crossorigin="" href="https://fonts.gstatic.com" rel="preconnect"/>
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;700;900&amp;display=swap" rel="stylesheet"/>
    <link href="https://fonts.googleapis.com/css2?family=Material+Symbols+Outlined" rel="stylesheet"/>
    <script>
        tailwind.config = {
            darkMode: "class",
            theme: {
                extend: {
                    colors: {
                        "primary": "#137fec",
                        "background-light": "#f6f7f8",
                        "background-dark": "#101922",
                        "status-active": "#28a745",
                        "status-inactive": "#6c757d",
                        "destructive": "#D0021B",
                        "success": "#2ECC71",
                    },
                    fontFamily: {
                        "display": ["Inter", "sans-serif"]
                    },
                },
            },
        }
    </script>
    <style>
        .material-symbols-outlined { font-variation-settings: 'FILL' 0, 'wght' 400, 'GRAD' 0, 'opsz' 24; }
        .view-section { display: none; }
        .view-section.active { display: block; }
        
        #loading-overlay {
            position: fixed; top: 0; left: 0; width: 100%; height: 100%;
            background: rgba(0,0,0,0.7); z-index: 9999;
            display: none; align-items: center; justify-content: center; color: white;
        }

        @container(max-width: 768px) { .table-col-updated { display: none; } }
        @container(max-width: 640px) { .table-col-status { display: none; } .table-col-shop-name { width: 60%; } .table-col-actions { width: 40%; } }
        @container(max-width: 480px) { .table-col-actions { display: none; } .table-col-shop-name { width: 100%; } }
    </style>
</head>
<body class="bg-background-light dark:bg-background-dark font-display text-gray-600 dark:text-gray-300">

    <!-- Loading Overlay -->
    <div id="loading-overlay">
        <div class="text-xl font-bold flex flex-col items-center gap-4">
            <span class="material-symbols-outlined animate-spin text-4xl">progress_activity</span>
            <span id="loading-message">Processing...</span>
        </div>
    </div>

    <!-- LANDING PAGE VIEW (Unchanged) -->
    <div id="view-landing" class="view-section active relative flex min-h-screen w-full flex-col overflow-x-hidden">
        <header class="sticky top-0 z-50 flex items-center justify-between whitespace-nowrap border-b border-solid border-gray-200/50 dark:border-white/10 bg-background-light/80 dark:bg-background-dark/80 px-10 py-3 backdrop-blur-sm">
            <div class="flex items-center gap-4 text-gray-800 dark:text-white cursor-pointer">
                <div class="size-6 text-primary">
                    <svg fill="currentColor" viewbox="0 0 48 48" xmlns="http://www.w3.org/2000/svg"><path d="M36.7273 44C33.9891 44 31.6043 39.8386 30.3636 33.69C29.123 39.8386 26.7382 44 24 44C21.2618 44 18.877 39.8386 17.6364 33.69C16.3957 39.8386 14.0109 44 11.2727 44C7.25611 44 4 35.0457 4 24C4 12.9543 7.25611 4 11.2727 4C14.0109 4 16.3957 8.16144 17.6364 14.31C18.877 8.16144 21.2618 4 24 4C26.7382 4 29.123 8.16144 30.3636 14.31C31.6043 8.16144 33.9891 4 36.7273 4C40.7439 4 44 12.9543 44 24C44 35.0457 40.7439 44 36.7273 44Z"></path></svg>
                </div>
                <h2 class="text-lg font-bold leading-tight tracking-[-0.015em]">ShopSaaS</h2>
            </div>
            <div class="flex gap-2">
                <button onclick="switchView('view-auth')" class="rounded-lg h-10 px-4 bg-gray-200 dark:bg-white/10 text-gray-800 dark:text-white text-sm font-bold hover:bg-gray-300 dark:hover:bg-white/20">Login</button>
                <button onclick="switchView('view-auth')" class="rounded-lg h-10 px-4 bg-primary text-white text-sm font-bold hover:opacity-90">Sign Up Free</button>
            </div>
        </header>
        <div class="text-center py-20 lg:py-32 px-4">
            <h1 class="text-4xl font-black text-gray-900 dark:text-white sm:text-5xl md:text-6xl mb-4">The All-in-One Hub for Your E-commerce Empire.</h1>
            <p class="max-w-3xl mx-auto text-base text-gray-600 dark:text-gray-300 mb-8">Launch, manage, and scale multiple online stores from a single, intelligent dashboard.</p>
            <button onclick="switchView('view-auth')" class="rounded-lg h-12 px-5 bg-primary text-white text-base font-bold hover:opacity-90">Start Your Free Trial</button>
        </div>
    </div>

    <!-- AUTH VIEW (Unchanged) -->
    <div id="view-auth" class="view-section min-h-screen flex items-center justify-center p-5 bg-background-light dark:bg-background-dark">
        <div class="max-w-md w-full bg-white dark:bg-[#111418] p-8 rounded-xl border border-gray-200 dark:border-gray-800 shadow-xl">
            <div class="mb-6 cursor-pointer text-primary font-medium flex items-center gap-2" onclick="switchView('view-landing')">
                <span class="material-symbols-outlined">arrow_back</span> Back to Home
            </div>
            <h1 class="text-2xl font-bold text-gray-900 dark:text-white mb-2">Welcome to ShopSaaS</h1>
            <p class="text-gray-500 dark:text-gray-400 mb-8">Log in to manage your stores</p>
            <div class="flex flex-col gap-3 mb-6">
                <a href="/auth/google" class="flex items-center justify-center gap-3 p-3 rounded-lg border border-gray-200 dark:border-gray-700 hover:bg-gray-50 dark:hover:bg-gray-800 text-gray-700 dark:text-gray-200 font-medium transition-colors"><span>üîç</span> Continue with Google</a>
                <a href="/auth/github" class="flex items-center justify-center gap-3 p-3 rounded-lg border border-gray-200 dark:border-gray-700 hover:bg-gray-50 dark:hover:bg-gray-800 text-gray-700 dark:text-gray-200 font-medium transition-colors"><span>üêô</span> Continue with GitHub</a>
            </div>
            <div class="relative flex py-2 items-center mb-6">
                <div class="flex-grow border-t border-gray-200 dark:border-gray-700"></div><span class="flex-shrink-0 mx-4 text-gray-400 text-sm">or</span><div class="flex-grow border-t border-gray-200 dark:border-gray-700"></div>
            </div>
            <form id="auth-form" onsubmit="handlePasswordLogin(event)" class="flex flex-col gap-4">
                <div><label class="block text-sm font-medium text-gray-700 dark:text-gray-300 mb-1">Email Address</label><input type="email" id="login-email" required class="w-full rounded-lg border-gray-300 dark:border-gray-700 bg-white dark:bg-gray-800 text-gray-900 dark:text-white focus:ring-primary focus:border-primary" placeholder="you@example.com"></div>
                <div><label class="block text-sm font-medium text-gray-700 dark:text-gray-300 mb-1">Password</label><input type="password" id="login-password" required class="w-full rounded-lg border-gray-300 dark:border-gray-700 bg-white dark:bg-gray-800 text-gray-900 dark:text-white focus:ring-primary focus:border-primary" placeholder="‚Ä¢‚Ä¢‚Ä¢‚Ä¢‚Ä¢‚Ä¢‚Ä¢‚Ä¢"></div>
                <button type="submit" class="w-full py-3 rounded-lg bg-primary text-white font-bold hover:bg-primary/90 transition-colors">Sign In</button>
                <div class="text-center text-sm mt-2"><a href="#" onclick="handleRegister()" class="text-primary hover:underline">Create an account</a></div>
            </form>
        </div>
    </div>

    <!-- MAIN APP LAYOUT -->
    <div id="app-layout" class="view-section" style="display: none;">
        <div class="flex min-h-screen">
            <!-- Sidebar -->
            <aside class="hidden md:flex w-64 flex-col bg-white dark:bg-[#111418] border-r border-gray-200 dark:border-gray-800 p-4 fixed h-full z-20">
                <div class="flex items-center gap-2 mb-8 px-2">
                    <span class="material-symbols-outlined text-primary text-3xl">store</span>
                    <span class="text-2xl font-bold text-gray-900 dark:text-white">ShopSaaS</span>
                </div>
                <div class="flex flex-col gap-2 flex-1">
                    <a onclick="switchView('view-dashboard')" class="cursor-pointer flex items-center gap-3 px-3 py-2 rounded-lg hover:bg-gray-100 dark:hover:bg-gray-800 text-gray-600 dark:text-gray-300 nav-item" id="nav-dashboard">
                        <span class="material-symbols-outlined">dashboard</span><p class="text-sm font-medium">Dashboard</p>
                    </a>
                    <a onclick="switchView('view-shop-list')" class="cursor-pointer flex items-center gap-3 px-3 py-2 rounded-lg hover:bg-gray-100 dark:hover:bg-gray-800 text-gray-600 dark:text-gray-300 nav-item" id="nav-shops">
                        <span class="material-symbols-outlined">storefront</span><p class="text-sm font-medium">My Shops</p>
                    </a>
                    <a onclick="switchView('view-billing')" class="cursor-pointer flex items-center gap-3 px-3 py-2 rounded-lg hover:bg-gray-100 dark:hover:bg-gray-800 text-gray-600 dark:text-gray-300 nav-item" id="nav-billing">
                        <span class="material-symbols-outlined">credit_card</span><p class="text-sm font-medium">Billing</p>
                    </a>
                </div>
                <div class="flex gap-3 items-center border-t border-gray-200 dark:border-gray-800 pt-4 mt-auto">
                    <div class="bg-primary rounded-full size-10 flex items-center justify-center text-white font-bold" id="user-avatar">U</div>
                    <div class="flex flex-col overflow-hidden">
                        <h1 id="dashboard-user-name" class="text-gray-900 dark:text-white text-base font-medium leading-normal truncate">User</h1>
                        <p id="dashboard-user-email" class="text-gray-500 dark:text-gray-400 text-xs truncate">user@example.com</p>
                    </div>
                    <button onclick="logout()" class="ml-auto text-gray-500 hover:text-destructive"><span class="material-symbols-outlined">logout</span></button>
                </div>
            </aside>

            <!-- Main Content Area -->
            <main class="flex-1 p-8 md:ml-64 w-full">
                <div class="max-w-7xl mx-auto">
                    
                    <!-- DASHBOARD CONTENT -->
                    <div id="content-dashboard" class="content-section">
                        <div class="flex flex-wrap justify-between items-center gap-4 mb-8">
                            <p class="text-gray-900 dark:text-white text-4xl font-black leading-tight tracking-[-0.033em]">Dashboard</p>
                            <button onclick="switchView('view-create-shop')" class="flex items-center justify-center gap-2 rounded-lg h-10 px-4 bg-primary text-white text-sm font-bold hover:bg-primary/90 shadow-lg shadow-primary/20">
                                <span class="material-symbols-outlined">add_circle</span><span>Add New Shop</span>
                            </button>
                        </div>
                        <div class="grid grid-cols-1 md:grid-cols-2 gap-6 mb-8">
                            <div class="flex flex-col gap-4 rounded-xl p-6 bg-white dark:bg-[#111418] border border-gray-200 dark:border-gray-800">
                                <div class="flex items-center gap-2"><span class="material-symbols-outlined text-gray-500 dark:text-gray-400">account_balance_wallet</span><p class="text-gray-800 dark:text-white text-base font-medium">Credit Balance</p></div>
                                <p class="text-gray-900 dark:text-white text-4xl font-bold" id="dashboard-credits">0</p>
                                <button onclick="switchView('view-billing')" class="flex items-center text-sm font-bold text-primary hover:underline mt-2"><span>Add Credits</span> <span class="material-symbols-outlined text-sm ml-1">arrow_forward</span></button>
                            </div>
                            <div class="flex flex-col gap-4 rounded-xl p-6 bg-white dark:bg-[#111418] border border-gray-200 dark:border-gray-800">
                                <div class="flex items-center gap-2"><span class="material-symbols-outlined text-gray-500 dark:text-gray-400">psychology</span><p class="text-gray-800 dark:text-white text-base font-medium">System Status</p></div>
                                <div class="flex items-center gap-2"><span class="w-3 h-3 rounded-full bg-green-500"></span><p class="text-gray-900 dark:text-white text-2xl font-bold">Operational</p></div>
                            </div>
                        </div>
                        <h2 class="text-gray-900 dark:text-white text-[22px] font-bold mb-4">Recent Shops</h2>
                        <div id="dashboard-shops-grid" class="grid grid-cols-[repeat(auto-fit,minmax(300px,1fr))] gap-6"></div>
                    </div>

                    <!-- SHOP LIST CONTENT -->
                    <div id="content-shop-list" class="content-section" style="display: none;">
                         <div class="flex flex-wrap items-center justify-between gap-4 mb-6">
                            <p class="text-4xl font-black leading-tight tracking-[-0.033em] text-gray-900 dark:text-white">My Shops</p>
                            <button onclick="switchView('view-create-shop')" class="flex h-10 cursor-pointer items-center justify-center gap-2 overflow-hidden rounded-lg bg-primary px-4 text-sm font-bold leading-normal text-white hover:opacity-90"><span class="material-symbols-outlined text-lg">add</span><span class="truncate">Create New Shop</span></button>
                        </div>
                        <div class="flex flex-col gap-4 md:flex-row md:items-center md:justify-between mb-6">
                            <div class="relative flex-1">
                                <div class="pointer-events-none absolute inset-y-0 left-0 flex items-center pl-3"><span class="material-symbols-outlined text-gray-400">search</span></div>
                                <input type="text" id="shop-search" onkeyup="filterShops()" class="w-full rounded-lg border-gray-200 bg-white p-2 pl-10 text-gray-900 focus:border-primary focus:ring-primary dark:border-white/10 dark:bg-[#111418] dark:text-white sm:max-w-xs" placeholder="Search shops...">
                            </div>
                        </div>
                        <div class="@container">
                            <div class="overflow-hidden rounded-xl border border-gray-200 bg-white dark:bg-[#111418] dark:border-white/10">
                                <table class="w-full">
                                    <thead class="border-b border-gray-200 bg-gray-50 dark:border-white/10 dark:bg-white/5">
                                        <tr>
                                            <th class="table-col-shop-name w-2/5 px-6 py-3 text-left text-xs font-medium uppercase tracking-wider text-gray-500 dark:text-gray-400">Shop Name</th>
                                            <th class="table-col-status w-1/5 px-6 py-3 text-left text-xs font-medium uppercase tracking-wider text-gray-500 dark:text-gray-400">Status</th>
                                            <th class="table-col-updated w-1/5 px-6 py-3 text-left text-xs font-medium uppercase tracking-wider text-gray-500 dark:text-gray-400">Created At</th>
                                            <th class="table-col-actions w-1/5 px-6 py-3 text-left text-xs font-medium uppercase tracking-wider text-gray-500 dark:text-gray-400">Actions</th>
                                        </tr>
                                    </thead>
                                    <tbody id="shop-table-body" class="divide-y divide-gray-200 dark:divide-white/10"></tbody>
                                </table>
                            </div>
                        </div>
                    </div>

                    <!-- BILLING CONTENT -->
                    <div id="content-billing" class="content-section" style="display: none;">
                        <header class="flex flex-wrap justify-between gap-3 mb-8">
                            <div class="flex min-w-72 flex-col gap-2">
                                <h1 class="text-gray-900 dark:text-white text-4xl font-black leading-tight tracking-[-0.033em]">Credits &amp; Billing</h1>
                                <p class="text-gray-500 dark:text-gray-400 text-base font-normal leading-normal">Manage your credits, view transaction history, and subscriptions.</p>
                            </div>
                        </header>
                        <div class="bg-white dark:bg-[#111418] rounded-xl shadow-sm border border-gray-200 dark:border-gray-800 p-6 flex flex-col sm:flex-row items-start sm:items-center justify-between gap-6 mb-10">
                            <div class="flex flex-col gap-2">
                                <p class="text-gray-500 dark:text-gray-400 text-sm font-normal">Current Balance</p>
                                <p class="text-gray-900 dark:text-white text-5xl font-bold tracking-[-0.02em]" id="billing-credits-display">0</p>
                                <p class="text-gray-500 dark:text-gray-400 text-base font-normal">Your Available Credit Balance</p>
                            </div>
                            <button onclick="alert('Contact sales for credits!')" class="flex min-w-[84px] cursor-pointer items-center justify-center overflow-hidden rounded-lg h-10 px-5 bg-primary text-white text-sm font-bold leading-normal tracking-[0.015em] hover:bg-primary/90"><span class="truncate">Add Credits</span></button>
                        </div>
                        
                        <header class="flex justify-between items-center mb-4">
                            <h2 class="text-gray-900 dark:text-white text-[22px] font-bold leading-tight tracking-[-0.015em]">Transaction History</h2>
                            <button onclick="loadTransactions()" class="flex items-center justify-center overflow-hidden rounded-lg h-10 border border-gray-300 dark:border-gray-700 bg-white dark:bg-gray-800 text-gray-700 dark:text-gray-300 gap-2 text-sm font-medium leading-normal px-4 hover:bg-gray-100 dark:hover:bg-gray-700"><span class="material-symbols-outlined text-base">refresh</span> Refresh</button>
                        </header>
                        <div class="bg-white dark:bg-[#111418] rounded-xl shadow-sm border border-gray-200 dark:border-gray-800 overflow-hidden">
                            <div class="overflow-x-auto">
                                <table class="w-full text-sm text-left text-gray-500 dark:text-gray-400">
                                    <thead class="text-xs text-gray-700 uppercase bg-gray-50 dark:bg-gray-800 dark:text-gray-400">
                                        <tr>
                                            <th class="px-6 py-3">Date</th>
                                            <th class="px-6 py-3">Type</th>
                                            <th class="px-6 py-3">Description</th>
                                            <th class="px-6 py-3 text-right">Amount</th>
                                            <th class="px-6 py-3 text-right">Balance</th>
                                        </tr>
                                    </thead>
                                    <tbody id="billing-transactions-body"></tbody>
                                </table>
                            </div>
                        </div>
                    </div>

                    <!-- AI ASSISTANT MANAGEMENT CONTENT -->
                    <div id="content-ai-assistant" class="content-section" style="display: none;">
                         <div class="flex flex-wrap gap-2 mb-4">
                            <a onclick="switchView('view-shop-details')" class="text-gray-500 dark:text-gray-400 text-sm font-medium hover:text-primary cursor-pointer">Shop Details</a>
                            <span class="text-gray-500 dark:text-gray-400 text-sm font-medium">/</span>
                            <span class="text-[#333333] dark:text-white text-sm font-medium">AI Assistant</span>
                        </div>
                        <div class="flex flex-wrap justify-between items-center gap-3 mb-8">
                            <h1 class="text-[#333333] dark:text-white text-4xl font-black tracking-tight">AI Assistant Management</h1>
                        </div>
                        <div class="grid grid-cols-1 lg:grid-cols-3 gap-8">
                            <div class="lg:col-span-2 flex flex-col gap-8">
                                <div class="bg-white dark:bg-[#1C2127] rounded-xl shadow-sm p-6 border border-gray-200 dark:border-gray-700">
                                    <h2 class="text-lg font-bold text-[#333333] dark:text-white tracking-tight mb-4">AI Assistant Status</h2>
                                    <div class="flex items-center justify-between p-4 border border-gray-200 dark:border-gray-700 rounded-lg bg-gray-50 dark:bg-gray-800/50">
                                        <div class="flex flex-col">
                                            <label class="font-medium text-[#333333] dark:text-gray-200" for="ai-toggle">Enable AI Assistant</label>
                                            <div class="flex items-center gap-2 mt-1">
                                                <p class="text-sm text-[#777777] dark:text-gray-400">Status:</p>
                                                <div class="flex items-center gap-1.5" id="ai-status-indicator">
                                                    <div class="w-2 h-2 rounded-full bg-gray-400"></div><p class="text-sm font-medium text-gray-500">Disabled</p>
                                                </div>
                                            </div>
                                        </div>
                                        <label class="relative inline-flex items-center cursor-pointer">
                                            <input id="ai-toggle" type="checkbox" class="sr-only peer" onchange="toggleAiAssistant()">
                                            <div class="w-11 h-6 bg-gray-200 peer-focus:outline-none peer-focus:ring-2 peer-focus:ring-primary/50 rounded-full peer dark:bg-gray-700 peer-checked:after:translate-x-full peer-checked:after:border-white after:content-[''] after:absolute after:top-[2px] after:left-[2px] after:bg-white after:border-gray-300 after:border after:rounded-full after:h-5 after:w-5 after:transition-all peer-checked:bg-primary"></div>
                                        </label>
                                    </div>
                                </div>
                                <div class="bg-white dark:bg-[#1C2127] rounded-xl shadow-sm p-6 border border-gray-200 dark:border-gray-700">
                                    <h2 class="text-lg font-bold text-[#333333] dark:text-white tracking-tight mb-4">Features</h2>
                                    <ul class="space-y-4">
                                        <li class="flex items-start gap-3"><div class="flex-shrink-0 w-8 h-8 rounded-full bg-primary/20 flex items-center justify-center"><span class="material-symbols-outlined text-primary text-base">support_agent</span></div><div><h3 class="font-medium text-[#333333] dark:text-gray-200">Automated Support</h3><p class="text-sm text-[#777777] dark:text-gray-400">24/7 customer Q&A.</p></div></li>
                                        <li class="flex items-start gap-3"><div class="flex-shrink-0 w-8 h-8 rounded-full bg-primary/20 flex items-center justify-center"><span class="material-symbols-outlined text-primary text-base">auto_awesome</span></div><div><h3 class="font-medium text-[#333333] dark:text-gray-200">Smart Recommendations</h3><p class="text-sm text-[#777777] dark:text-gray-400">Boost AOV with AI suggestions.</p></div></li>
                                    </ul>
                                </div>
                            </div>
                            <div class="lg:col-span-1">
                                <div class="bg-white dark:bg-[#1C2127] rounded-xl shadow-sm p-6 sticky top-8 border border-gray-200 dark:border-gray-700">
                                    <h2 class="text-lg font-bold text-[#333333] dark:text-white tracking-tight mb-4">Cost</h2>
                                    <div class="space-y-4">
                                        <div><p class="text-sm text-[#777777] dark:text-gray-400">Activation Fee</p><p class="text-2xl font-bold text-[#333333] dark:text-white">50 <span class="text-base font-medium text-[#777777] dark:text-gray-400">credits</span></p></div>
                                        <div class="bg-blue-50 dark:bg-primary/20 p-3 rounded-lg flex items-start gap-3"><span class="material-symbols-outlined text-primary mt-0.5 text-lg">info</span><p class="text-sm text-blue-800 dark:text-blue-200">One-time fee per shop.</p></div>
                                    </div>
                                </div>
                            </div>
                        </div>
                    </div>

                </div>
            </main>
        </div>
    </div>

    <!-- CREATE SHOP & SHOP DETAILS (Standalone Views) ... -->
    <div id="view-create-shop" class="view-section bg-background-light dark:bg-background-dark min-h-screen">
        <div class="max-w-4xl mx-auto p-8">
            <header class="mb-8">
                <div class="flex items-center gap-2 text-sm text-gray-500 dark:text-gray-400 mb-4"><a onclick="switchView('view-dashboard')" class="hover:text-primary cursor-pointer">Dashboard</a><span>/</span><span class="text-gray-900 dark:text-white">Create New Shop</span></div>
                <h1 class="text-3xl font-bold text-gray-900 dark:text-white">Create Your New Shop</h1>
            </header>
            <form onsubmit="handleCreateShop(event)" class="grid grid-cols-1 lg:grid-cols-3 gap-8">
                <div class="lg:col-span-2 flex flex-col gap-6">
                    <div class="bg-white dark:bg-[#111418] p-6 rounded-xl border border-gray-200 dark:border-gray-800">
                        <h2 class="text-lg font-bold text-gray-900 dark:text-white mb-6">Shop Details</h2>
                        <div class="space-y-6">
                            <div><label class="block text-sm font-medium text-gray-700 dark:text-gray-300 mb-2">Shop Name</label><input type="text" name="shop_name" required class="w-full rounded-lg border-gray-300 dark:border-gray-700 bg-white dark:bg-gray-800 text-gray-900 dark:text-white h-12 px-4"></div>
                            <div><label class="block text-sm font-medium text-gray-700 dark:text-gray-300 mb-2">Admin Email</label><input type="email" name="admin_email" required class="w-full rounded-lg border-gray-300 dark:border-gray-700 bg-white dark:bg-gray-800 text-gray-900 dark:text-white h-12 px-4"></div>
                            <div><label class="block text-sm font-medium text-gray-700 dark:text-gray-300 mb-2">Admin Password (min 8 chars)</label><input type="password" name="admin_password" required minlength="8" class="w-full rounded-lg border-gray-300 dark:border-gray-700 bg-white dark:bg-gray-800 text-gray-900 dark:text-white h-12 px-4"></div>
                        </div>
                    </div>
                </div>
                <div class="lg:col-span-1 space-y-4">
                    <div class="bg-primary/5 dark:bg-primary/10 p-6 rounded-xl border border-primary/20">
                        <h3 class="font-bold text-primary mb-2">Launch</h3>
                        <button type="submit" class="w-full py-3 rounded-lg bg-primary text-white font-bold hover:bg-primary/90 shadow-lg shadow-primary/20">Create Shop</button>
                        <button type="button" onclick="switchView('view-dashboard')" class="w-full mt-3 py-3 rounded-lg border border-gray-300 dark:border-gray-700 text-gray-600 dark:text-gray-300 font-medium hover:bg-gray-50 dark:hover:bg-gray-800">Cancel</button>
                    </div>
                </div>
            </form>
        </div>
    </div>

    <div id="view-shop-details" class="view-section bg-background-light dark:bg-background-dark min-h-screen">
         <div class="flex min-h-screen">
             <aside class="hidden md:flex w-64 flex-col bg-white dark:bg-[#111418] border-r border-gray-200 dark:border-gray-800 p-4 fixed h-full">
                 <div class="flex items-center gap-2 mb-8 px-2"><span class="material-symbols-outlined text-primary text-3xl">store</span><span class="text-2xl font-bold text-gray-900 dark:text-white">ShopSaaS</span></div>
                <div class="flex flex-col gap-2 flex-1">
                    <a onclick="switchView('view-dashboard')" class="cursor-pointer flex items-center gap-3 px-3 py-2 rounded-lg hover:bg-gray-100 dark:hover:bg-gray-800 text-gray-600 dark:text-gray-300"><span class="material-symbols-outlined">dashboard</span><p class="text-sm font-medium">Dashboard</p></a>
                     <a onclick="switchView('view-shop-list')" class="cursor-pointer flex items-center gap-3 px-3 py-2 rounded-lg hover:bg-gray-100 dark:hover:bg-gray-800 text-gray-600 dark:text-gray-300"><span class="material-symbols-outlined">storefront</span><p class="text-sm font-medium">My Shops</p></a>
                </div>
             </aside>
             <main class="flex-1 p-8 md:ml-64">
                <div class="max-w-5xl mx-auto">
                    <div class="mb-4 flex items-center gap-2 text-sm"><a onclick="switchView('view-shop-list')" class="cursor-pointer text-gray-500 hover:text-primary">Shops</a><span class="material-symbols-outlined text-sm text-gray-400">chevron_right</span><span id="detail-shop-name-crumb" class="font-medium text-gray-900 dark:text-white">Shop Name</span></div>
                    <div class="mb-8 flex flex-wrap items-center justify-between gap-4">
                        <div class="flex items-center gap-4"><h1 id="detail-shop-name" class="text-3xl font-bold text-gray-900 dark:text-white">Shop Name</h1><span id="detail-shop-status" class="px-2.5 py-0.5 rounded-full text-xs font-semibold bg-gray-100 text-gray-800">Status</span></div>
                        <div class="flex gap-2">
                            <a id="detail-shop-link" href="#" target="_blank" class="flex items-center gap-2 px-4 py-2 rounded-lg border border-gray-300 dark:border-gray-700 bg-white dark:bg-gray-800 text-gray-700 dark:text-white hover:bg-gray-50 dark:hover:bg-gray-700 font-medium"><span class="material-symbols-outlined text-base">visibility</span> Visit</a>
                            <a id="detail-admin-link" href="#" target="_blank" class="flex items-center gap-2 px-4 py-2 rounded-lg bg-primary text-white hover:bg-primary/90 font-medium"><span class="material-symbols-outlined text-base">admin_panel_settings</span> Admin Panel</a>
                        </div>
                    </div>
                    <div class="grid grid-cols-1 lg:grid-cols-3 gap-8">
                        <div class="lg:col-span-2 space-y-6">
                            <div class="bg-white dark:bg-[#111418] rounded-xl border border-gray-200 dark:border-gray-800 p-5 space-y-4">
                                <div><label class="text-xs font-medium text-gray-500 uppercase">App Name</label><p id="detail-app-name" class="text-base text-gray-900 dark:text-white font-mono mt-1">app-name</p></div>
                                <div><label class="text-xs font-medium text-gray-500 uppercase">Domain</label><p id="detail-domain" class="text-base text-gray-900 dark:text-white mt-1">...</p></div>
                                <div><label class="text-xs font-medium text-gray-500 uppercase">Created At</label><p id="detail-created" class="text-base text-gray-900 dark:text-white mt-1">...</p></div>
                            </div>
                            <div class="bg-white dark:bg-[#111418] rounded-xl border border-gray-200 dark:border-gray-800 p-5">
                                <h2 class="font-bold text-gray-900 dark:text-white mb-4">Integrations</h2>
                                <div class="flex items-center justify-between p-4 border border-gray-200 dark:border-gray-700 rounded-lg bg-gray-50 dark:bg-gray-800/50 cursor-pointer hover:bg-gray-100 dark:hover:bg-gray-800" onclick="openAiManagement()">
                                    <div class="flex items-center gap-3">
                                        <div class="bg-primary/10 p-2 rounded-lg text-primary"><span class="material-symbols-outlined">smart_toy</span></div>
                                        <div><h3 class="font-bold text-sm">AI Assistant</h3><p class="text-xs text-gray-500" id="detail-ai-status">Status: Unknown</p></div>
                                    </div>
                                    <span class="material-symbols-outlined text-gray-400">chevron_right</span>
                                </div>
                            </div>
                        </div>
                        <div class="space-y-6">
                             <div class="bg-white dark:bg-[#111418] rounded-xl border border-red-200 dark:border-red-900/30 overflow-hidden">
                                <div class="p-5 border-b border-red-100 dark:border-red-900/30 bg-red-50/50 dark:bg-red-900/10"><h2 class="font-bold text-red-700 dark:text-red-400">Danger Zone</h2></div>
                                <div class="p-5"><button onclick="handleDeleteShop()" class="w-full flex items-center justify-center gap-2 px-4 py-2 rounded-lg bg-destructive text-white hover:bg-red-700 font-medium"><span class="material-symbols-outlined text-base">delete</span> Delete Shop</button></div>
                            </div>
                        </div>
                    </div>
                </div>
             </main>
         </div>
    </div>

    <script>
        // --- GLOBAL STATE ---
        let currentUser = null;
        let currentShopId = null;
        let allShops = [];

        function switchView(viewId) {
            document.querySelectorAll('.view-section').forEach(el => el.classList.remove('active'));
            ['nav-dashboard', 'nav-shops', 'nav-billing'].forEach(id => document.getElementById(id).classList.remove('bg-primary/10', 'dark:bg-primary/20', 'text-primary'));
            
            const appLayout = document.getElementById('app-layout');
            if (['view-dashboard', 'view-shop-list', 'view-billing', 'content-ai-assistant'].includes(viewId) || viewId.startsWith('content-')) {
                appLayout.style.display = 'block';
                document.querySelectorAll('.content-section').forEach(el => el.style.display = 'none');
                
                let contentId = viewId.startsWith('content-') ? viewId : 'content-' + viewId.replace('view-', '');
                // AI management is a sub-view of shop details technically but we show it in main layout for now or standalone? 
                // Let's put Billing and AI in main layout.
                
                if (viewId === 'view-ai-management') contentId = 'content-ai-assistant';

                const contentEl = document.getElementById(contentId);
                if(contentEl) contentEl.style.display = 'block';
                
                // Nav highlight
                if (contentId === 'content-dashboard') document.getElementById('nav-dashboard').classList.add('bg-primary/10', 'dark:bg-primary/20', 'text-primary');
                if (contentId === 'content-shop-list') document.getElementById('nav-shops').classList.add('bg-primary/10', 'dark:bg-primary/20', 'text-primary');
                if (contentId === 'content-billing') document.getElementById('nav-billing').classList.add('bg-primary/10', 'dark:bg-primary/20', 'text-primary');

                if (contentId === 'content-dashboard') loadDashboard();
                if (contentId === 'content-shop-list') loadShopList();
                if (contentId === 'content-billing') loadBilling();

            } else {
                appLayout.style.display = 'none';
                const target = document.getElementById(viewId);
                if(target) target.classList.add('active');
            }
        }

        function showLoading(show, message = "Loading...") {
            document.getElementById('loading-overlay').style.display = show ? 'flex' : 'none';
            document.getElementById('loading-message').textContent = message;
        }

        // --- AUTH ---
        async function checkAuth() {
            try {
                const res = await fetch('/api/user');
                const data = await res.json();
                if (data.user) { currentUser = data.user; updateUserUI(); switchView('view-dashboard'); } else { switchView('view-landing'); }
            } catch (e) { switchView('view-landing'); }
        }
        function updateUserUI() {
            if (!currentUser) return;
            document.querySelectorAll('#dashboard-user-name').forEach(el => el.textContent = currentUser.name || 'User');
            document.querySelectorAll('#dashboard-user-email').forEach(el => el.textContent = currentUser.email);
            document.querySelectorAll('#user-avatar').forEach(el => el.textContent = (currentUser.name || currentUser.email)[0].toUpperCase());
        }
        async function handlePasswordLogin(e) {
            e.preventDefault(); showLoading(true);
            const email = document.getElementById('login-email').value; const password = document.getElementById('login-password').value;
            try { const res = await fetch('/auth/password/login', { method: 'POST', headers: {'Content-Type': 'application/json'}, body: JSON.stringify({email, password})});
            if(res.ok) checkAuth(); else alert('Failed'); } catch(e){alert(e);} finally{showLoading(false);}
        }
        async function logout() { await fetch('/auth/logout', {method:'POST'}); currentUser=null; switchView('view-landing'); }
        async function handleRegister() { /* ... */ } // (Keep existing)

        // --- DATA FETCHING ---
        async function fetchShops() {
            const res = await fetch('/api/shops'); const data = await res.json();
            allShops = (data.shops || []).filter(s => s.status !== 'deleted');
            fetch('/api/billing/summary').then(r => r.json()).then(d => {
                document.querySelectorAll('#dashboard-credits').forEach(el => el.textContent = d.credits || 0);
                document.getElementById('billing-credits-display').textContent = d.credits || 0;
            });
            return allShops;
        }

        // --- DASHBOARD ---
        async function loadDashboard() { const shops = await fetchShops(); renderDashboardGrid(shops.slice(0,6)); }
        function renderDashboardGrid(shops) {
             const container = document.getElementById('dashboard-shops-grid');
             if(shops.length===0) { container.innerHTML = '<div class="col-span-full text-gray-500">No shops.</div>'; return; }
             container.innerHTML = shops.map(s => `
                <div class="flex flex-col gap-4 p-6 bg-white dark:bg-[#111418] border border-gray-200 dark:border-gray-800 rounded-xl hover:shadow-md transition-all">
                    <div class="flex items-center gap-3">
                        <div class="size-12 rounded-lg bg-primary/10 flex items-center justify-center text-primary text-xl font-bold">${s.shop_name.substring(0,2).toUpperCase()}</div>
                        <div class="flex-1 min-w-0"><p class="text-gray-900 dark:text-white text-base font-bold truncate">${s.shop_name}</p><p class="text-gray-500 dark:text-gray-400 text-xs truncate">${s.app_name}.fly.dev</p></div>
                        <span class="inline-flex items-center rounded-full px-2.5 py-0.5 text-xs font-medium ${getStatusColor(s.status)}">${s.status}</span>
                    </div>
                    <div class="flex gap-2 mt-auto pt-4">
                        <button onclick="openShopDetails(${s.id})" class="flex-1 h-9 px-3 text-sm font-bold rounded-lg bg-gray-100 dark:bg-gray-800 text-gray-800 dark:text-gray-200 hover:bg-gray-200">Manage</button>
                        <a href="https://${s.app_name}.fly.dev" target="_blank" class="flex-1 h-9 flex items-center justify-center px-3 text-sm font-bold rounded-lg bg-primary/10 text-primary hover:bg-primary/20">Visit</a>
                    </div>
                </div>`).join('');
        }

        // --- SHOP LIST ---
        async function loadShopList() { const shops = await fetchShops(); renderShopTable(shops); }
        function renderShopTable(shops) {
            const tbody = document.getElementById('shop-table-body');
            if(shops.length===0) { tbody.innerHTML='<tr><td colspan="4" class="px-6 py-4 text-center text-gray-500">No shops.</td></tr>'; return; }
            tbody.innerHTML = shops.map(s => `
                <tr class="hover:bg-gray-50 dark:hover:bg-white/5 transition-colors">
                    <td class="table-col-shop-name px-6 py-4 text-sm font-medium text-gray-900 dark:text-white">
                        <div class="flex items-center gap-3"><div class="size-8 rounded bg-primary/10 flex items-center justify-center text-primary font-bold text-xs">${s.shop_name.substring(0,1)}</div>
                        <div><p>${s.shop_name}</p><p class="text-xs text-gray-500">${s.app_name}</p></div></div>
                    </td>
                    <td class="table-col-status px-6 py-4 text-sm"><span class="inline-flex items-center gap-2 rounded-full px-2.5 py-0.5 text-xs font-medium ${getStatusColor(s.status)}"><span class="size-1.5 rounded-full bg-current"></span> ${s.status}</span></td>
                    <td class="table-col-updated px-6 py-4 text-sm text-gray-500 dark:text-gray-400">${new Date(s.created_at).toLocaleDateString()}</td>
                    <td class="table-col-actions px-6 py-4 text-sm">
                        <div class="flex items-center gap-2">
                            <button onclick="openShopDetails(${s.id})" class="p-1.5 rounded text-gray-500 hover:bg-gray-100 dark:hover:bg-white/10 hover:text-primary"><span class="material-symbols-outlined text-lg">visibility</span></button>
                        </div>
                    </td>
                </tr>`).join('');
        }
        function filterShops() {
            const q = document.getElementById('shop-search').value.toLowerCase();
            renderShopTable(allShops.filter(s => s.shop_name.toLowerCase().includes(q) || s.app_name.toLowerCase().includes(q)));
        }
        function getStatusColor(s) { if(s==='active') return 'bg-green-100 text-green-800 dark:bg-green-900/50 dark:text-green-300'; if(s==='creating') return 'bg-yellow-100 text-yellow-800 dark:bg-yellow-900/50 dark:text-yellow-300'; return 'bg-gray-100 text-gray-800 dark:bg-gray-800 dark:text-gray-300'; }

        // --- DETAILS & AI ---
        async function openShopDetails(id) {
            currentShopId = id; showLoading(true);
            try {
                const res = await fetch(`/api/shops/${id}/status`);
                const d = await res.json();
                renderShopDetails(d.shop);
                // Check AI status
                const aiRes = await fetch(`/api/shops/${id}/chatbot/status`);
                const aiData = await aiRes.json();
                document.getElementById('detail-ai-status').textContent = aiData.enabled ? 'Active' : 'Disabled';
                document.getElementById('detail-ai-status').className = aiData.enabled ? 'text-xs text-green-600' : 'text-xs text-gray-500';
                
                switchView('view-shop-details');
            } catch(e) { alert(e.message); } finally { showLoading(false); }
        }
        function renderShopDetails(s) {
            document.getElementById('detail-shop-name').textContent = s.shop_name;
            document.getElementById('detail-app-name').textContent = s.app_name;
            document.getElementById('detail-domain').textContent = s.domain || `${s.app_name}.fly.dev`;
            document.getElementById('detail-created').textContent = new Date(s.created_at).toLocaleString();
            document.getElementById('detail-shop-status').textContent = s.status;
            document.getElementById('detail-shop-link').href = `https://${s.domain||s.app_name+'.fly.dev'}`;
            document.getElementById('detail-admin-link').href = `https://${s.domain||s.app_name+'.fly.dev'}/admin`;
        }

        // --- AI MANAGEMENT ---
        async function openAiManagement() {
            showLoading(true);
            try {
                const res = await fetch(`/api/shops/${currentShopId}/chatbot/status`);
                const data = await res.json();
                const toggle = document.getElementById('ai-toggle');
                const statusDiv = document.getElementById('ai-status-indicator');
                
                toggle.checked = data.enabled;
                if (data.enabled) {
                    statusDiv.innerHTML = '<div class="w-2 h-2 rounded-full bg-success"></div><p class="text-sm font-medium text-success">Active</p>';
                } else {
                    statusDiv.innerHTML = '<div class="w-2 h-2 rounded-full bg-gray-400"></div><p class="text-sm font-medium text-gray-500">Disabled</p>';
                }
                
                // We need to render the AI content inside the app layout
                switchView('view-ai-management'); 
            } catch(e) { alert(e.message); } finally { showLoading(false); }
        }

        async function toggleAiAssistant() {
            const toggle = document.getElementById('ai-toggle');
            if (!toggle.checked) {
                alert("Disabling is not fully implemented via this toggle yet.");
                toggle.checked = true; 
                return;
            }
            
            if (!confirm("Enabling AI Assistant costs 50 credits. Proceed?")) {
                toggle.checked = false;
                return;
            }

            showLoading(true, "Enabling AI...");
            try {
                const res = await fetch(`/api/shops/${currentShopId}/chatbot/enable`, {
                    method: 'POST', headers: {'Content-Type': 'application/json'}
                });
                const d = await res.json();
                if (res.ok) {
                    alert("AI Assistant Enabled!");
                    openAiManagement(); // Refresh
                } else {
                    throw new Error(d.error || "Failed");
                }
            } catch(e) { 
                alert(e.message); 
                toggle.checked = false;
            } finally { showLoading(false); }
        }

        // --- BILLING ---
        async function loadBilling() {
            showLoading(true);
            try {
                const res = await fetch('/api/billing/transactions');
                const data = await res.json();
                const tbody = document.getElementById('billing-transactions-body');
                if (!data.transactions || data.transactions.length === 0) {
                    tbody.innerHTML = '<tr><td colspan="5" class="px-6 py-4 text-center">No transactions found.</td></tr>';
                } else {
                    tbody.innerHTML = data.transactions.map(t => `
                        <tr class="bg-white dark:bg-transparent border-b dark:border-gray-800">
                            <td class="px-6 py-4 font-medium">${new Date(t.created_at).toLocaleDateString()}</td>
                            <td class="px-6 py-4"><span class="inline-flex items-center gap-1.5 py-1 px-2 rounded-full text-xs font-medium ${t.amount < 0 ? 'bg-red-100 text-red-800' : 'bg-green-100 text-green-800'}">${t.amount < 0 ? 'Debit' : 'Credit'}</span></td>
                            <td class="px-6 py-4">${t.reason}</td>
                            <td class="px-6 py-4 text-right font-mono ${t.amount < 0 ? 'text-red-500' : 'text-green-500'}">${t.amount > 0 ? '+' : ''}${t.amount}</td>
                            <td class="px-6 py-4 text-right font-mono">${t.balance_after}</td>
                        </tr>
                    `).join('');
                }
            } catch(e) { console.error(e); } finally { showLoading(false); }
        }
        async function loadTransactions() { loadBilling(); }

        // --- CREATE & DELETE ---
        async function handleCreateShop(e) { /* ... (Same as before) ... */ 
             e.preventDefault(); const formData = new FormData(e.target); const data = Object.fromEntries(formData.entries());
             showLoading(true, "Provisioning...");
             try { const res = await fetch('/api/shops', {method:'POST', headers:{'Content-Type':'application/json'}, body:JSON.stringify(data)});
             if(res.ok) { alert('Started!'); e.target.reset(); switchView('view-dashboard'); } else { const d=await res.json(); alert(d.error); } } catch(e){alert(e);} finally{showLoading(false);}
        }
        async function handleDeleteShop() {
             if(!confirm("Delete?")) return; showLoading(true);
             try { const res = await fetch(`/api/shops/${currentShopId}`, {method:'DELETE'}); if(res.ok) { alert('Deleted'); switchView('view-dashboard'); } else alert('Failed'); } catch(e) { alert(e.message); } finally { showLoading(false); }
        }

        // Init
        checkAuth();
    </script>
</body>
</html>