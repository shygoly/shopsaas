<!DOCTYPE html>
<html class="dark" lang="en">
<head>
    <meta charset="utf-8"/>
    <meta content="width=device-width, initial-scale=1.0" name="viewport"/>
    <title>ShopSaaS - Manage Your E-commerce Empire</title>
    <script src="https://cdn.tailwindcss.com?plugins=forms,container-queries"></script>
    <link href="https://fonts.googleapis.com" rel="preconnect"/>
    <link crossorigin="" href="https://fonts.gstatic.com" rel="preconnect"/>
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;700;900&amp;display=swap" rel="stylesheet"/>
    <link href="https://fonts.googleapis.com/css2?family=Material+Symbols+Outlined" rel="stylesheet"/>
    <script>
        tailwind.config = {
            darkMode: "class",
            theme: {
                extend: {
                    colors: {
                        "primary": "#137fec",
                        "background-light": "#f6f7f8",
                        "background-dark": "#101922",
                        "status-active": "#28a745",
                        "status-inactive": "#6c757d",
                        "destructive": "#D0021B",
                    },
                    fontFamily: {
                        "display": ["Inter", "sans-serif"]
                    },
                },
            },
        }
    </script>
    <style>
        .material-symbols-outlined { font-variation-settings: 'FILL' 0, 'wght' 400, 'GRAD' 0, 'opsz' 24; }
        .view-section { display: none; }
        .view-section.active { display: block; }
        
        /* Loading Overlay */
        #loading-overlay {
            position: fixed; top: 0; left: 0; width: 100%; height: 100%;
            background: rgba(0,0,0,0.7); z-index: 9999;
            display: none; align-items: center; justify-content: center; color: white;
        }
    </style>
</head>
<body class="bg-background-light dark:bg-background-dark font-display text-gray-600 dark:text-gray-300">

    <!-- Loading Overlay -->
    <div id="loading-overlay">
        <div class="text-xl font-bold flex flex-col items-center gap-4">
            <span class="material-symbols-outlined animate-spin text-4xl">progress_activity</span>
            <span id="loading-message">Processing...</span>
        </div>
    </div>

    <!-- LANDING PAGE VIEW -->
    <div id="view-landing" class="view-section active relative flex min-h-screen w-full flex-col overflow-x-hidden">
        <!-- ... (Landing Page Header & Content from previous step) ... -->
        <header class="sticky top-0 z-50 flex items-center justify-between whitespace-nowrap border-b border-solid border-gray-200/50 dark:border-white/10 bg-background-light/80 dark:bg-background-dark/80 px-10 py-3 backdrop-blur-sm">
            <div class="flex items-center gap-4 text-gray-800 dark:text-white cursor-pointer">
                <div class="size-6 text-primary">
                    <svg fill="currentColor" viewbox="0 0 48 48" xmlns="http://www.w3.org/2000/svg"><path d="M36.7273 44C33.9891 44 31.6043 39.8386 30.3636 33.69C29.123 39.8386 26.7382 44 24 44C21.2618 44 18.877 39.8386 17.6364 33.69C16.3957 39.8386 14.0109 44 11.2727 44C7.25611 44 4 35.0457 4 24C4 12.9543 7.25611 4 11.2727 4C14.0109 4 16.3957 8.16144 17.6364 14.31C18.877 8.16144 21.2618 4 24 4C26.7382 4 29.123 8.16144 30.3636 14.31C31.6043 8.16144 33.9891 4 36.7273 4C40.7439 4 44 12.9543 44 24C44 35.0457 40.7439 44 36.7273 44Z"></path></svg>
                </div>
                <h2 class="text-lg font-bold leading-tight tracking-[-0.015em]">ShopSaaS</h2>
            </div>
            <div class="flex gap-2">
                <button onclick="switchView('view-auth')" class="rounded-lg h-10 px-4 bg-gray-200 dark:bg-white/10 text-gray-800 dark:text-white text-sm font-bold hover:bg-gray-300 dark:hover:bg-white/20">Login</button>
                <button onclick="switchView('view-auth')" class="rounded-lg h-10 px-4 bg-primary text-white text-sm font-bold hover:opacity-90">Sign Up Free</button>
            </div>
        </header>
        <div class="text-center py-20 lg:py-32 px-4">
            <h1 class="text-4xl font-black text-gray-900 dark:text-white sm:text-5xl md:text-6xl mb-4">The All-in-One Hub for Your E-commerce Empire.</h1>
            <p class="max-w-3xl mx-auto text-base text-gray-600 dark:text-gray-300 mb-8">Launch, manage, and scale multiple online stores from a single, intelligent dashboard.</p>
            <button onclick="switchView('view-auth')" class="rounded-lg h-12 px-5 bg-primary text-white text-base font-bold hover:opacity-90">Start Your Free Trial</button>
        </div>
    </div>

    <!-- AUTH VIEW -->
    <div id="view-auth" class="view-section min-h-screen flex items-center justify-center p-5 bg-background-light dark:bg-background-dark">
        <div class="max-w-md w-full bg-white dark:bg-[#111418] p-8 rounded-xl border border-gray-200 dark:border-gray-800 shadow-xl">
            <div class="mb-6 cursor-pointer text-primary font-medium flex items-center gap-2" onclick="switchView('view-landing')">
                <span class="material-symbols-outlined">arrow_back</span> Back to Home
            </div>
            <h1 class="text-2xl font-bold text-gray-900 dark:text-white mb-2">Welcome to ShopSaaS</h1>
            <p class="text-gray-500 dark:text-gray-400 mb-8">Log in to manage your stores</p>
            
            <div class="flex flex-col gap-3 mb-6">
                <a href="/auth/google" class="flex items-center justify-center gap-3 p-3 rounded-lg border border-gray-200 dark:border-gray-700 hover:bg-gray-50 dark:hover:bg-gray-800 text-gray-700 dark:text-gray-200 font-medium transition-colors">
                    <span>üîç</span> Continue with Google
                </a>
                <a href="/auth/github" class="flex items-center justify-center gap-3 p-3 rounded-lg border border-gray-200 dark:border-gray-700 hover:bg-gray-50 dark:hover:bg-gray-800 text-gray-700 dark:text-gray-200 font-medium transition-colors">
                    <span>üêô</span> Continue with GitHub
                </a>
            </div>
            
            <div class="relative flex py-2 items-center mb-6">
                <div class="flex-grow border-t border-gray-200 dark:border-gray-700"></div>
                <span class="flex-shrink-0 mx-4 text-gray-400 text-sm">or</span>
                <div class="flex-grow border-t border-gray-200 dark:border-gray-700"></div>
            </div>
            
            <form id="auth-form" onsubmit="handlePasswordLogin(event)" class="flex flex-col gap-4">
                <div>
                    <label class="block text-sm font-medium text-gray-700 dark:text-gray-300 mb-1">Email Address</label>
                    <input type="email" id="login-email" required class="w-full rounded-lg border-gray-300 dark:border-gray-700 bg-white dark:bg-gray-800 text-gray-900 dark:text-white focus:ring-primary focus:border-primary" placeholder="you@example.com">
                </div>
                <div>
                    <label class="block text-sm font-medium text-gray-700 dark:text-gray-300 mb-1">Password</label>
                    <input type="password" id="login-password" required class="w-full rounded-lg border-gray-300 dark:border-gray-700 bg-white dark:bg-gray-800 text-gray-900 dark:text-white focus:ring-primary focus:border-primary" placeholder="‚Ä¢‚Ä¢‚Ä¢‚Ä¢‚Ä¢‚Ä¢‚Ä¢‚Ä¢">
                </div>
                <button type="submit" class="w-full py-3 rounded-lg bg-primary text-white font-bold hover:bg-primary/90 transition-colors">Sign In</button>
                <div class="text-center text-sm mt-2">
                    <a href="#" onclick="handleRegister()" class="text-primary hover:underline">Create an account</a>
                </div>
            </form>
        </div>
    </div>

    <!-- DASHBOARD VIEW -->
    <div id="view-dashboard" class="view-section bg-background-light dark:bg-background-dark font-display">
        <div class="flex min-h-screen">
            <!-- Sidebar -->
            <aside class="hidden md:flex w-64 flex-col bg-white dark:bg-[#111418] border-r border-gray-200 dark:border-gray-800 p-4 fixed h-full">
                <div class="flex items-center gap-2 mb-8 px-2">
                    <span class="material-symbols-outlined text-primary text-3xl">store</span>
                    <span class="text-2xl font-bold text-gray-900 dark:text-white">ShopSaaS</span>
                </div>
                <div class="flex flex-col gap-2 flex-1">
                    <a onclick="switchView('view-dashboard')" class="cursor-pointer flex items-center gap-3 px-3 py-2 rounded-lg bg-primary/10 dark:bg-primary/20 text-primary">
                        <span class="material-symbols-outlined">dashboard</span>
                        <p class="text-sm font-medium">Dashboard</p>
                    </a>
                    <a onclick="switchView('view-shop-list')" class="cursor-pointer flex items-center gap-3 px-3 py-2 text-gray-600 dark:text-gray-300 hover:bg-gray-100 dark:hover:bg-gray-800 rounded-lg">
                        <span class="material-symbols-outlined">storefront</span>
                        <p class="text-sm font-medium">Shops</p>
                    </a>
                </div>
                <div class="flex gap-3 items-center border-t border-gray-200 dark:border-gray-800 pt-4 mt-auto">
                    <div class="bg-primary rounded-full size-10 flex items-center justify-center text-white font-bold" id="user-avatar">U</div>
                    <div class="flex flex-col overflow-hidden">
                        <h1 id="dashboard-user-name" class="text-gray-900 dark:text-white text-base font-medium leading-normal truncate">User</h1>
                        <p id="dashboard-user-email" class="text-gray-500 dark:text-gray-400 text-xs truncate">user@example.com</p>
                    </div>
                    <button onclick="logout()" class="ml-auto text-gray-500 hover:text-destructive"><span class="material-symbols-outlined">logout</span></button>
                </div>
            </aside>

            <!-- Main Content -->
            <main class="flex-1 p-8 md:ml-64">
                <div class="max-w-7xl mx-auto">
                    <!-- Header -->
                    <div class="flex flex-wrap justify-between items-center gap-4 mb-8">
                        <p class="text-gray-900 dark:text-white text-4xl font-black leading-tight tracking-[-0.033em]">Dashboard</p>
                        <button onclick="switchView('view-create-shop')" class="flex items-center justify-center gap-2 rounded-lg h-10 px-4 bg-primary text-white text-sm font-bold hover:bg-primary/90 shadow-lg shadow-primary/20">
                            <span class="material-symbols-outlined">add_circle</span>
                            <span>Add New Shop</span>
                        </button>
                    </div>

                    <!-- Stats Cards -->
                    <div class="grid grid-cols-1 md:grid-cols-2 gap-6 mb-8">
                        <div class="flex flex-col gap-4 rounded-xl p-6 bg-white dark:bg-[#111418] border border-gray-200 dark:border-gray-800">
                            <div class="flex items-center gap-2">
                                <span class="material-symbols-outlined text-gray-500 dark:text-gray-400">account_balance_wallet</span>
                                <p class="text-gray-800 dark:text-white text-base font-medium">Credit Balance</p>
                            </div>
                            <p class="text-gray-900 dark:text-white text-4xl font-bold" id="dashboard-credits">0</p>
                            <button class="flex items-center text-sm font-bold text-primary hover:underline mt-2">
                                <span>Add Credits</span> <span class="material-symbols-outlined text-sm ml-1">arrow_forward</span>
                            </button>
                        </div>
                        <div class="flex flex-col gap-4 rounded-xl p-6 bg-white dark:bg-[#111418] border border-gray-200 dark:border-gray-800">
                            <div class="flex items-center gap-2">
                                <span class="material-symbols-outlined text-gray-500 dark:text-gray-400">psychology</span>
                                <p class="text-gray-800 dark:text-white text-base font-medium">System Status</p>
                            </div>
                            <div class="flex items-center gap-2">
                                <span class="w-3 h-3 rounded-full bg-green-500"></span>
                                <p class="text-gray-900 dark:text-white text-2xl font-bold">Operational</p>
                            </div>
                        </div>
                    </div>

                    <!-- Shops Grid -->
                    <h2 class="text-gray-900 dark:text-white text-[22px] font-bold mb-4">Your Shops</h2>
                    <div id="dashboard-shops-grid" class="grid grid-cols-[repeat(auto-fit,minmax(300px,1fr))] gap-6">
                        <!-- Shops will be injected here -->
                        <div class="text-gray-500 italic">Loading shops...</div>
                    </div>
                </div>
            </main>
        </div>
    </div>

    <!-- CREATE SHOP VIEW -->
    <div id="view-create-shop" class="view-section bg-background-light dark:bg-background-dark min-h-screen">
        <div class="max-w-4xl mx-auto p-8">
            <header class="mb-8">
                <div class="flex items-center gap-2 text-sm text-gray-500 dark:text-gray-400 mb-4">
                    <a href="#" onclick="switchView('view-dashboard')" class="hover:text-primary">Dashboard</a>
                    <span>/</span>
                    <span class="text-gray-900 dark:text-white">Create New Shop</span>
                </div>
                <h1 class="text-3xl font-bold text-gray-900 dark:text-white">Create Your New Shop</h1>
                <p class="text-gray-500 dark:text-gray-400 mt-2">Launch a new storefront in minutes.</p>
            </header>

            <form onsubmit="handleCreateShop(event)" class="grid grid-cols-1 lg:grid-cols-3 gap-8">
                <div class="lg:col-span-2 flex flex-col gap-6">
                    <!-- Details -->
                    <div class="bg-white dark:bg-[#111418] p-6 rounded-xl border border-gray-200 dark:border-gray-800">
                        <h2 class="text-lg font-bold text-gray-900 dark:text-white mb-6">Shop Details</h2>
                        
                        <div class="space-y-6">
                            <div>
                                <label class="block text-sm font-medium text-gray-700 dark:text-gray-300 mb-2">Shop Name</label>
                                <input type="text" name="shop_name" required class="w-full rounded-lg border-gray-300 dark:border-gray-700 bg-white dark:bg-gray-800 text-gray-900 dark:text-white h-12 px-4" placeholder="e.g. My Awesome Store">
                            </div>
                            
                            <div>
                                <label class="block text-sm font-medium text-gray-700 dark:text-gray-300 mb-2">Admin Email</label>
                                <input type="email" name="admin_email" required class="w-full rounded-lg border-gray-300 dark:border-gray-700 bg-white dark:bg-gray-800 text-gray-900 dark:text-white h-12 px-4" placeholder="admin@yourstore.com">
                            </div>
                            
                            <div>
                                <label class="block text-sm font-medium text-gray-700 dark:text-gray-300 mb-2">Admin Password (min 8 chars)</label>
                                <input type="password" name="admin_password" required minlength="8" class="w-full rounded-lg border-gray-300 dark:border-gray-700 bg-white dark:bg-gray-800 text-gray-900 dark:text-white h-12 px-4" placeholder="Strong password">
                            </div>
                        </div>
                    </div>

                    <!-- Theme Selection (Visual Only for now) -->
                    <div class="bg-white dark:bg-[#111418] p-6 rounded-xl border border-gray-200 dark:border-gray-800">
                        <h2 class="text-lg font-bold text-gray-900 dark:text-white mb-4">Select Starting Theme</h2>
                        <div class="grid grid-cols-1 sm:grid-cols-2 gap-4">
                            <div class="border-2 border-primary rounded-lg p-4 cursor-pointer bg-gray-50 dark:bg-gray-800 relative">
                                <div class="absolute top-2 right-2 text-primary bg-white dark:bg-gray-900 rounded-full p-1"><span class="material-symbols-outlined text-sm">check</span></div>
                                <div class="h-20 bg-gray-200 dark:bg-gray-700 rounded mb-3"></div>
                                <h3 class="font-bold text-gray-900 dark:text-white">Standard</h3>
                                <p class="text-xs text-gray-500">Default responsive theme</p>
                            </div>
                        </div>
                    </div>
                </div>

                <!-- Sidebar Actions -->
                <div class="lg:col-span-1 space-y-4">
                    <div class="bg-primary/5 dark:bg-primary/10 p-6 rounded-xl border border-primary/20">
                        <h3 class="font-bold text-primary mb-2">Ready to Launch?</h3>
                        <p class="text-sm text-gray-600 dark:text-gray-300 mb-4">Your shop will be provisioned immediately. DNS propagation may take a few minutes.</p>
                        <button type="submit" class="w-full py-3 rounded-lg bg-primary text-white font-bold hover:bg-primary/90 shadow-lg shadow-primary/20">
                            Create Shop
                        </button>
                        <button type="button" onclick="switchView('view-dashboard')" class="w-full mt-3 py-3 rounded-lg border border-gray-300 dark:border-gray-700 text-gray-600 dark:text-gray-300 font-medium hover:bg-gray-50 dark:hover:bg-gray-800">
                            Cancel
                        </button>
                    </div>
                </div>
            </form>
        </div>
    </div>

    <!-- SHOP DETAILS VIEW -->
    <div id="view-shop-details" class="view-section bg-background-light dark:bg-background-dark min-h-screen">
        <div class="flex min-h-screen">
             <!-- Reused Sidebar (hidden on mobile) -->
             <aside class="hidden md:flex w-64 flex-col bg-white dark:bg-[#111418] border-r border-gray-200 dark:border-gray-800 p-4 fixed h-full">
                <div class="flex items-center gap-2 mb-8 px-2">
                    <span class="material-symbols-outlined text-primary text-3xl">store</span>
                    <span class="text-2xl font-bold text-gray-900 dark:text-white">ShopSaaS</span>
                </div>
                <div class="flex flex-col gap-2 flex-1">
                    <a onclick="switchView('view-dashboard')" class="cursor-pointer flex items-center gap-3 px-3 py-2 text-gray-600 dark:text-gray-300 hover:bg-gray-100 dark:hover:bg-gray-800 rounded-lg">
                        <span class="material-symbols-outlined">dashboard</span>
                        <p class="text-sm font-medium">Dashboard</p>
                    </a>
                </div>
            </aside>

            <main class="flex-1 p-8 md:ml-64">
                <div class="max-w-5xl mx-auto">
                    <!-- Breadcrumbs -->
                    <div class="mb-4 flex items-center gap-2 text-sm">
                        <a onclick="switchView('view-dashboard')" class="cursor-pointer text-gray-500 hover:text-primary">Shops</a>
                        <span class="material-symbols-outlined text-sm text-gray-400">chevron_right</span>
                        <span id="detail-shop-name-crumb" class="font-medium text-gray-900 dark:text-white">Shop Name</span>
                    </div>

                    <!-- Header -->
                    <div class="mb-8 flex flex-wrap items-center justify-between gap-4">
                        <div class="flex items-center gap-4">
                            <h1 id="detail-shop-name" class="text-3xl font-bold text-gray-900 dark:text-white">Shop Name</h1>
                            <span id="detail-shop-status" class="px-2.5 py-0.5 rounded-full text-xs font-semibold bg-gray-100 text-gray-800">Status</span>
                        </div>
                        <div class="flex gap-2">
                            <a id="detail-shop-link" href="#" target="_blank" class="flex items-center gap-2 px-4 py-2 rounded-lg border border-gray-300 dark:border-gray-700 bg-white dark:bg-gray-800 text-gray-700 dark:text-white hover:bg-gray-50 dark:hover:bg-gray-700 font-medium">
                                <span class="material-symbols-outlined text-base">visibility</span> Visit
                            </a>
                            <a id="detail-admin-link" href="#" target="_blank" class="flex items-center gap-2 px-4 py-2 rounded-lg bg-primary text-white hover:bg-primary/90 font-medium">
                                <span class="material-symbols-outlined text-base">admin_panel_settings</span> Admin Panel
                            </a>
                        </div>
                    </div>

                    <!-- Details Grid -->
                    <div class="grid grid-cols-1 lg:grid-cols-3 gap-8">
                        <!-- Info Card -->
                        <div class="lg:col-span-2 space-y-6">
                            <div class="bg-white dark:bg-[#111418] rounded-xl border border-gray-200 dark:border-gray-800 overflow-hidden">
                                <div class="p-5 border-b border-gray-200 dark:border-gray-800">
                                    <h2 class="font-bold text-gray-900 dark:text-white">Shop Information</h2>
                                </div>
                                <div class="p-5 space-y-4">
                                    <div>
                                        <label class="text-xs font-medium text-gray-500 uppercase">App Name</label>
                                        <p id="detail-app-name" class="text-base text-gray-900 dark:text-white font-mono bg-gray-50 dark:bg-gray-900 p-2 rounded mt-1 select-all">app-name</p>
                                    </div>
                                    <div>
                                        <label class="text-xs font-medium text-gray-500 uppercase">Domain</label>
                                        <p id="detail-domain" class="text-base text-gray-900 dark:text-white mt-1">...</p>
                                    </div>
                                    <div>
                                        <label class="text-xs font-medium text-gray-500 uppercase">Created At</label>
                                        <p id="detail-created" class="text-base text-gray-900 dark:text-white mt-1">...</p>
                                    </div>
                                </div>
                            </div>
                        </div>

                        <!-- Actions Column -->
                        <div class="space-y-6">
                             <div class="bg-white dark:bg-[#111418] rounded-xl border border-red-200 dark:border-red-900/30 overflow-hidden">
                                <div class="p-5 border-b border-red-100 dark:border-red-900/30 bg-red-50/50 dark:bg-red-900/10">
                                    <h2 class="font-bold text-red-700 dark:text-red-400">Danger Zone</h2>
                                </div>
                                <div class="p-5">
                                    <p class="text-sm text-gray-500 mb-4">Permanently delete this shop and all its data.</p>
                                    <button onclick="handleDeleteShop()" class="w-full flex items-center justify-center gap-2 px-4 py-2 rounded-lg bg-destructive text-white hover:bg-red-700 font-medium">
                                        <span class="material-symbols-outlined text-base">delete</span> Delete Shop
                                    </button>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>
            </main>
        </div>
    </div>

    <script>
        // --- GLOBAL STATE & UTILS ---
        let currentUser = null;
        let currentShopId = null;

        function switchView(viewId) {
            document.querySelectorAll('.view-section').forEach(el => el.classList.remove('active'));
            document.getElementById(viewId).classList.add('active');
            
            // View specific logic
            if (viewId === 'view-dashboard') loadDashboard();
        }

        function showLoading(show, message = "Loading...") {
            const el = document.getElementById('loading-overlay');
            document.getElementById('loading-message').textContent = message;
            el.style.display = show ? 'flex' : 'none';
        }

        // --- AUTH LOGIC ---
        async function checkAuth() {
            try {
                const res = await fetch('/api/user');
                const data = await res.json();
                if (data.user) {
                    currentUser = data.user;
                    updateUserUI();
                    switchView('view-dashboard');
                } else {
                    switchView('view-landing');
                }
            } catch (e) {
                console.error("Auth check failed", e);
                switchView('view-landing');
            }
        }

        function updateUserUI() {
            if (!currentUser) return;
            document.getElementById('dashboard-user-name').textContent = currentUser.name || 'User';
            document.getElementById('dashboard-user-email').textContent = currentUser.email;
            document.getElementById('user-avatar').textContent = (currentUser.name || currentUser.email)[0].toUpperCase();
        }

        async function handlePasswordLogin(e) {
            e.preventDefault();
            showLoading(true, "Signing in...");
            const email = document.getElementById('login-email').value;
            const password = document.getElementById('login-password').value;
            
            try {
                const res = await fetch('/auth/password/login', {
                    method: 'POST', headers: {'Content-Type': 'application/json'},
                    body: JSON.stringify({email, password})
                });
                if (res.ok) {
                    checkAuth();
                } else {
                    const d = await res.json();
                    alert(d.error || 'Login failed');
                }
            } catch (err) {
                alert('Login error: ' + err.message);
            } finally {
                showLoading(false);
            }
        }

        async function handleRegister() {
            const name = prompt('Your Name');
            const email = prompt('Email');
            const password = prompt('Password (min 8 chars)');
            if(!email || !password) return;
            
            showLoading(true, "Creating account...");
            try {
                const res = await fetch('/auth/password/register', {
                    method: 'POST', headers: {'Content-Type': 'application/json'},
                    body: JSON.stringify({email, password, name})
                });
                if (res.ok) {
                    alert('Account created! Please sign in.');
                } else {
                    const d = await res.json();
                    alert(d.error || 'Failed');
                }
            } catch (e) { alert(e.message); }
            finally { showLoading(false); }
        }

        async function logout() {
            await fetch('/auth/logout', { method: 'POST' });
            currentUser = null;
            switchView('view-landing');
        }

        // --- DASHBOARD LOGIC ---
        async function loadDashboard() {
            try {
                // Load credits
                fetch('/api/billing/summary').then(r => r.json()).then(d => {
                    document.getElementById('dashboard-credits').textContent = d.credits || 0;
                });

                // Load shops
                const res = await fetch('/api/shops');
                const data = await res.json();
                renderShopsGrid(data.shops || []);
            } catch (e) {
                console.error(e);
            }
        }

        function renderShopsGrid(shops) {
            const container = document.getElementById('dashboard-shops-grid');
            const validShops = shops.filter(s => s.status !== 'deleted');
            
            if (validShops.length === 0) {
                container.innerHTML = `
                    <div class="col-span-full flex flex-col items-center justify-center p-10 border-2 border-dashed border-gray-300 dark:border-gray-700 rounded-xl">
                        <p class="text-gray-500 mb-4">You haven't created any shops yet.</p>
                        <button onclick="switchView('view-create-shop')" class="text-primary font-bold hover:underline">Create your first shop</button>
                    </div>
                `;
                return;
            }

            container.innerHTML = validShops.map(shop => `
                <div class="flex flex-col gap-4 p-6 bg-white dark:bg-[#111418] border border-gray-200 dark:border-gray-800 rounded-xl transition-all hover:shadow-md">
                    <div class="flex items-center gap-3">
                        <div class="size-12 rounded-lg bg-primary/10 flex items-center justify-center text-primary text-xl font-bold">
                            ${shop.shop_name.substring(0,2).toUpperCase()}
                        </div>
                        <div class="flex-1 min-w-0">
                            <p class="text-gray-900 dark:text-white text-base font-bold truncate">${shop.shop_name}</p>
                            <p class="text-gray-500 dark:text-gray-400 text-xs truncate">${shop.app_name}.fly.dev</p>
                        </div>
                        <span class="inline-flex items-center rounded-full px-2.5 py-0.5 text-xs font-medium ${getStatusColor(shop.status)}">
                            ${shop.status}
                        </span>
                    </div>
                    <div class="flex gap-2 mt-auto pt-4">
                        <button onclick="openShopDetails(${shop.id})" class="flex-1 h-9 px-3 text-sm font-bold rounded-lg bg-gray-100 dark:bg-gray-800 text-gray-800 dark:text-gray-200 hover:bg-gray-200 dark:hover:bg-gray-700">Manage</button>
                        <a href="https://${shop.app_name}.fly.dev" target="_blank" class="flex-1 h-9 flex items-center justify-center px-3 text-sm font-bold rounded-lg bg-primary/10 text-primary hover:bg-primary/20">Visit</a>
                    </div>
                </div>
            `).join('');
        }

        function getStatusColor(status) {
            if (status === 'active') return 'bg-green-100 text-green-800 dark:bg-green-900/50 dark:text-green-300';
            if (status === 'creating') return 'bg-yellow-100 text-yellow-800 dark:bg-yellow-900/50 dark:text-yellow-300';
            if (status === 'failed') return 'bg-red-100 text-red-800 dark:bg-red-900/50 dark:text-red-300';
            return 'bg-gray-100 text-gray-800';
        }

        // --- CREATE SHOP LOGIC ---
        async function handleCreateShop(e) {
            e.preventDefault();
            const form = e.target;
            const formData = new FormData(form);
            const data = Object.fromEntries(formData.entries());
            
            showLoading(true, "Provisioning your shop... This may take a moment.");
            
            try {
                const res = await fetch('/api/shops', {
                    method: 'POST', headers: {'Content-Type': 'application/json'},
                    body: JSON.stringify(data)
                });
                const result = await res.json();
                
                if (res.ok) {
                    alert('Shop creation initiated! You will be redirected to the dashboard.');
                    form.reset();
                    switchView('view-dashboard');
                } else {
                    throw new Error(result.error || 'Failed to create shop');
                }
            } catch (err) {
                alert(err.message);
            } finally {
                showLoading(false);
            }
        }

        // --- SHOP DETAILS LOGIC ---
        async function openShopDetails(shopId) {
            currentShopId = shopId;
            showLoading(true, "Loading details...");
            try {
                const res = await fetch(`/api/shops/${shopId}/status`);
                if (!res.ok) throw new Error("Failed to load shop");
                const data = await res.json();
                renderShopDetails(data.shop);
                switchView('view-shop-details');
            } catch (e) {
                alert(e.message);
            } finally {
                showLoading(false);
            }
        }

        function renderShopDetails(shop) {
            document.getElementById('detail-shop-name').textContent = shop.shop_name;
            document.getElementById('detail-shop-name-crumb').textContent = shop.shop_name;
            document.getElementById('detail-app-name').textContent = shop.app_name;
            
            const domain = shop.domain || `${shop.app_name}.fly.dev`;
            document.getElementById('detail-domain').textContent = domain;
            document.getElementById('detail-created').textContent = new Date(shop.created_at).toLocaleString();
            
            document.getElementById('detail-shop-status').textContent = shop.status;
            document.getElementById('detail-shop-status').className = `px-2.5 py-0.5 rounded-full text-xs font-semibold ${getStatusColor(shop.status)}`;
            
            document.getElementById('detail-shop-link').href = `https://${domain}`;
            document.getElementById('detail-admin-link').href = `https://${domain}/admin`;
        }

        async function handleDeleteShop() {
            if (!confirm("Are you sure? This action cannot be undone.")) return;
            showLoading(true, "Deleting...");
            try {
                const res = await fetch(`/api/shops/${currentShopId}`, { method: 'DELETE' });
                if (res.ok) {
                    alert('Shop deleted.');
                    switchView('view-dashboard');
                } else {
                    alert('Failed to delete.');
                }
            } catch (e) { alert(e.message); }
            finally { showLoading(false); }
        }

        // Initial Load
        checkAuth();

    </script>
</body>
</html>