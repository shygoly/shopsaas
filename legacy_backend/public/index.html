<!DOCTYPE html>
<html class="dark" lang="en">
<head>
    <meta charset="utf-8"/>
    <meta content="width=device-width, initial-scale=1.0" name="viewport"/>
    <title>ShopSaaS - Manage Your E-commerce Empire</title>
    <script src="https://cdn.tailwindcss.com?plugins=forms,container-queries"></script>
    <link href="https://fonts.googleapis.com" rel="preconnect"/>
    <link crossorigin="" href="https://fonts.gstatic.com" rel="preconnect"/>
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;700;900&amp;display=swap" rel="stylesheet"/>
    <link href="https://fonts.googleapis.com/css2?family=Material+Symbols+Outlined" rel="stylesheet"/>
    <script>
        tailwind.config = {
            darkMode: "class",
            theme: {
                extend: {
                    colors: {
                        "primary": "#137fec",
                        "background-light": "#f6f7f8",
                        "background-dark": "#101922",
                        "status-active": "#28a745",
                        "status-inactive": "#6c757d",
                        "destructive": "#D0021B",
                    },
                    fontFamily: {
                        "display": ["Inter", "sans-serif"]
                    },
                },
            },
        }
    </script>
    <style>
        .material-symbols-outlined { font-variation-settings: 'FILL' 0, 'wght' 400, 'GRAD' 0, 'opsz' 24; }
        .view-section { display: none; }
        .view-section.active { display: block; }
        
        /* Loading Overlay */
        #loading-overlay {
            position: fixed; top: 0; left: 0; width: 100%; height: 100%;
            background: rgba(0,0,0,0.7); z-index: 9999;
            display: none; align-items: center; justify-content: center; color: white;
        }

        /* Table Styles */
        @container(max-width: 768px) { .table-col-updated { display: none; } }
        @container(max-width: 640px) { .table-col-status { display: none; } .table-col-shop-name { width: 60%; } .table-col-actions { width: 40%; } }
        @container(max-width: 480px) { .table-col-actions { display: none; } .table-col-shop-name { width: 100%; } }
    </style>
</head>
<body class="bg-background-light dark:bg-background-dark font-display text-gray-600 dark:text-gray-300">

    <!-- Loading Overlay -->
    <div id="loading-overlay">
        <div class="text-xl font-bold flex flex-col items-center gap-4">
            <span class="material-symbols-outlined animate-spin text-4xl">progress_activity</span>
            <span id="loading-message">Processing...</span>
        </div>
    </div>

    <!-- LANDING PAGE VIEW -->
    <div id="view-landing" class="view-section active relative flex min-h-screen w-full flex-col overflow-x-hidden">
        <header class="sticky top-0 z-50 flex items-center justify-between whitespace-nowrap border-b border-solid border-gray-200/50 dark:border-white/10 bg-background-light/80 dark:bg-background-dark/80 px-10 py-3 backdrop-blur-sm">
            <div class="flex items-center gap-4 text-gray-800 dark:text-white cursor-pointer">
                <div class="size-6 text-primary">
                    <svg fill="currentColor" viewbox="0 0 48 48" xmlns="http://www.w3.org/2000/svg"><path d="M36.7273 44C33.9891 44 31.6043 39.8386 30.3636 33.69C29.123 39.8386 26.7382 44 24 44C21.2618 44 18.877 39.8386 17.6364 33.69C16.3957 39.8386 14.0109 44 11.2727 44C7.25611 44 4 35.0457 4 24C4 12.9543 7.25611 4 11.2727 4C14.0109 4 16.3957 8.16144 17.6364 14.31C18.877 8.16144 21.2618 4 24 4C26.7382 4 29.123 8.16144 30.3636 14.31C31.6043 8.16144 33.9891 4 36.7273 4C40.7439 4 44 12.9543 44 24C44 35.0457 40.7439 44 36.7273 44Z"></path></svg>
                </div>
                <h2 class="text-lg font-bold leading-tight tracking-[-0.015em]">ShopSaaS</h2>
            </div>
            <div class="flex gap-2">
                <button onclick="switchView('view-auth')" class="rounded-lg h-10 px-4 bg-gray-200 dark:bg-white/10 text-gray-800 dark:text-white text-sm font-bold hover:bg-gray-300 dark:hover:bg-white/20">Login</button>
                <button onclick="switchView('view-auth')" class="rounded-lg h-10 px-4 bg-primary text-white text-sm font-bold hover:opacity-90">Sign Up Free</button>
            </div>
        </header>
        <div class="text-center py-20 lg:py-32 px-4">
            <h1 class="text-4xl font-black text-gray-900 dark:text-white sm:text-5xl md:text-6xl mb-4">The All-in-One Hub for Your E-commerce Empire.</h1>
            <p class="max-w-3xl mx-auto text-base text-gray-600 dark:text-gray-300 mb-8">Launch, manage, and scale multiple online stores from a single, intelligent dashboard.</p>
            <button onclick="switchView('view-auth')" class="rounded-lg h-12 px-5 bg-primary text-white text-base font-bold hover:opacity-90">Start Your Free Trial</button>
        </div>
    </div>

    <!-- AUTH VIEW -->
    <div id="view-auth" class="view-section min-h-screen flex items-center justify-center p-5 bg-background-light dark:bg-background-dark">
        <div class="max-w-md w-full bg-white dark:bg-[#111418] p-8 rounded-xl border border-gray-200 dark:border-gray-800 shadow-xl">
            <div class="mb-6 cursor-pointer text-primary font-medium flex items-center gap-2" onclick="switchView('view-landing')">
                <span class="material-symbols-outlined">arrow_back</span> Back to Home
            </div>
            <h1 class="text-2xl font-bold text-gray-900 dark:text-white mb-2">Welcome to ShopSaaS</h1>
            <p class="text-gray-500 dark:text-gray-400 mb-8">Log in to manage your stores</p>
            
            <div class="flex flex-col gap-3 mb-6">
                <a href="/auth/google" class="flex items-center justify-center gap-3 p-3 rounded-lg border border-gray-200 dark:border-gray-700 hover:bg-gray-50 dark:hover:bg-gray-800 text-gray-700 dark:text-gray-200 font-medium transition-colors">
                    <span>üîç</span> Continue with Google
                </a>
                <a href="/auth/github" class="flex items-center justify-center gap-3 p-3 rounded-lg border border-gray-200 dark:border-gray-700 hover:bg-gray-50 dark:hover:bg-gray-800 text-gray-700 dark:text-gray-200 font-medium transition-colors">
                    <span>üêô</span> Continue with GitHub
                </a>
            </div>
            
            <div class="relative flex py-2 items-center mb-6">
                <div class="flex-grow border-t border-gray-200 dark:border-gray-700"></div>
                <span class="flex-shrink-0 mx-4 text-gray-400 text-sm">or</span>
                <div class="flex-grow border-t border-gray-200 dark:border-gray-700"></div>
            </div>
            
            <form id="auth-form" onsubmit="handlePasswordLogin(event)" class="flex flex-col gap-4">
                <div>
                    <label class="block text-sm font-medium text-gray-700 dark:text-gray-300 mb-1">Email Address</label>
                    <input type="email" id="login-email" required class="w-full rounded-lg border-gray-300 dark:border-gray-700 bg-white dark:bg-gray-800 text-gray-900 dark:text-white focus:ring-primary focus:border-primary" placeholder="you@example.com">
                </div>
                <div>
                    <label class="block text-sm font-medium text-gray-700 dark:text-gray-300 mb-1">Password</label>
                    <input type="password" id="login-password" required class="w-full rounded-lg border-gray-300 dark:border-gray-700 bg-white dark:bg-gray-800 text-gray-900 dark:text-white focus:ring-primary focus:border-primary" placeholder="‚Ä¢‚Ä¢‚Ä¢‚Ä¢‚Ä¢‚Ä¢‚Ä¢‚Ä¢">
                </div>
                <button type="submit" class="w-full py-3 rounded-lg bg-primary text-white font-bold hover:bg-primary/90 transition-colors">Sign In</button>
                <div class="text-center text-sm mt-2">
                    <a href="#" onclick="handleRegister()" class="text-primary hover:underline">Create an account</a>
                </div>
            </form>
        </div>
    </div>

    <!-- MAIN APP LAYOUT (Shared for Dashboard, Shop List, etc.) -->
    <div id="app-layout" class="view-section" style="display: none;">
        <div class="flex min-h-screen">
            <!-- Sidebar -->
            <aside class="hidden md:flex w-64 flex-col bg-white dark:bg-[#111418] border-r border-gray-200 dark:border-gray-800 p-4 fixed h-full z-20">
                <div class="flex items-center gap-2 mb-8 px-2">
                    <span class="material-symbols-outlined text-primary text-3xl">store</span>
                    <span class="text-2xl font-bold text-gray-900 dark:text-white">ShopSaaS</span>
                </div>
                <div class="flex flex-col gap-2 flex-1">
                    <a onclick="switchView('view-dashboard')" class="cursor-pointer flex items-center gap-3 px-3 py-2 rounded-lg hover:bg-gray-100 dark:hover:bg-gray-800 text-gray-600 dark:text-gray-300 nav-item" id="nav-dashboard">
                        <span class="material-symbols-outlined">dashboard</span>
                        <p class="text-sm font-medium">Dashboard</p>
                    </a>
                    <a onclick="switchView('view-shop-list')" class="cursor-pointer flex items-center gap-3 px-3 py-2 rounded-lg hover:bg-gray-100 dark:hover:bg-gray-800 text-gray-600 dark:text-gray-300 nav-item" id="nav-shops">
                        <span class="material-symbols-outlined">storefront</span>
                        <p class="text-sm font-medium">My Shops</p>
                    </a>
                </div>
                <div class="flex gap-3 items-center border-t border-gray-200 dark:border-gray-800 pt-4 mt-auto">
                    <div class="bg-primary rounded-full size-10 flex items-center justify-center text-white font-bold" id="user-avatar">U</div>
                    <div class="flex flex-col overflow-hidden">
                        <h1 id="dashboard-user-name" class="text-gray-900 dark:text-white text-base font-medium leading-normal truncate">User</h1>
                        <p id="dashboard-user-email" class="text-gray-500 dark:text-gray-400 text-xs truncate">user@example.com</p>
                    </div>
                    <button onclick="logout()" class="ml-auto text-gray-500 hover:text-destructive"><span class="material-symbols-outlined">logout</span></button>
                </div>
            </aside>

            <!-- Main Content Area -->
            <main class="flex-1 p-8 md:ml-64 w-full">
                <div class="max-w-7xl mx-auto">
                    
                    <!-- DASHBOARD CONTENT -->
                    <div id="content-dashboard" class="content-section">
                        <div class="flex flex-wrap justify-between items-center gap-4 mb-8">
                            <p class="text-gray-900 dark:text-white text-4xl font-black leading-tight tracking-[-0.033em]">Dashboard</p>
                            <button onclick="switchView('view-create-shop')" class="flex items-center justify-center gap-2 rounded-lg h-10 px-4 bg-primary text-white text-sm font-bold hover:bg-primary/90 shadow-lg shadow-primary/20">
                                <span class="material-symbols-outlined">add_circle</span>
                                <span>Add New Shop</span>
                            </button>
                        </div>

                        <div class="grid grid-cols-1 md:grid-cols-2 gap-6 mb-8">
                            <div class="flex flex-col gap-4 rounded-xl p-6 bg-white dark:bg-[#111418] border border-gray-200 dark:border-gray-800">
                                <div class="flex items-center gap-2">
                                    <span class="material-symbols-outlined text-gray-500 dark:text-gray-400">account_balance_wallet</span>
                                    <p class="text-gray-800 dark:text-white text-base font-medium">Credit Balance</p>
                                </div>
                                <p class="text-gray-900 dark:text-white text-4xl font-bold" id="dashboard-credits">0</p>
                                <button class="flex items-center text-sm font-bold text-primary hover:underline mt-2">
                                    <span>Add Credits</span> <span class="material-symbols-outlined text-sm ml-1">arrow_forward</span>
                                </button>
                            </div>
                            <div class="flex flex-col gap-4 rounded-xl p-6 bg-white dark:bg-[#111418] border border-gray-200 dark:border-gray-800">
                                <div class="flex items-center gap-2">
                                    <span class="material-symbols-outlined text-gray-500 dark:text-gray-400">psychology</span>
                                    <p class="text-gray-800 dark:text-white text-base font-medium">System Status</p>
                                </div>
                                <div class="flex items-center gap-2">
                                    <span class="w-3 h-3 rounded-full bg-green-500"></span>
                                    <p class="text-gray-900 dark:text-white text-2xl font-bold">Operational</p>
                                </div>
                            </div>
                        </div>

                        <h2 class="text-gray-900 dark:text-white text-[22px] font-bold mb-4">Recent Shops</h2>
                        <div id="dashboard-shops-grid" class="grid grid-cols-[repeat(auto-fit,minmax(300px,1fr))] gap-6">
                            <!-- Shops injected via JS -->
                        </div>
                    </div>

                    <!-- SHOP LIST CONTENT (Table View) -->
                    <div id="content-shop-list" class="content-section" style="display: none;">
                         <div class="flex flex-wrap items-center justify-between gap-4 mb-6">
                            <p class="text-4xl font-black leading-tight tracking-[-0.033em] text-gray-900 dark:text-white">My Shops</p>
                            <button onclick="switchView('view-create-shop')" class="flex h-10 cursor-pointer items-center justify-center gap-2 overflow-hidden rounded-lg bg-primary px-4 text-sm font-bold leading-normal text-white hover:opacity-90">
                                <span class="material-symbols-outlined text-lg">add</span>
                                <span class="truncate">Create New Shop</span>
                            </button>
                        </div>
                        
                        <!-- Search & Filters -->
                        <div class="flex flex-col gap-4 md:flex-row md:items-center md:justify-between mb-6">
                            <div class="relative flex-1">
                                <div class="pointer-events-none absolute inset-y-0 left-0 flex items-center pl-3">
                                    <span class="material-symbols-outlined text-gray-400">search</span>
                                </div>
                                <input type="text" id="shop-search" onkeyup="filterShops()" class="w-full rounded-lg border-gray-200 bg-white p-2 pl-10 text-gray-900 focus:border-primary focus:ring-primary dark:border-white/10 dark:bg-[#111418] dark:text-white sm:max-w-xs" placeholder="Search shops...">
                            </div>
                        </div>

                        <!-- Table Container -->
                        <div class="@container">
                            <div class="overflow-hidden rounded-xl border border-gray-200 bg-white dark:bg-[#111418] dark:border-white/10">
                                <table class="w-full">
                                    <thead class="border-b border-gray-200 bg-gray-50 dark:border-white/10 dark:bg-white/5">
                                        <tr>
                                            <th class="table-col-shop-name w-2/5 px-6 py-3 text-left text-xs font-medium uppercase tracking-wider text-gray-500 dark:text-gray-400">Shop Name</th>
                                            <th class="table-col-status w-1/5 px-6 py-3 text-left text-xs font-medium uppercase tracking-wider text-gray-500 dark:text-gray-400">Status</th>
                                            <th class="table-col-updated w-1/5 px-6 py-3 text-left text-xs font-medium uppercase tracking-wider text-gray-500 dark:text-gray-400">Created At</th>
                                            <th class="table-col-actions w-1/5 px-6 py-3 text-left text-xs font-medium uppercase tracking-wider text-gray-500 dark:text-gray-400">Actions</th>
                                        </tr>
                                    </thead>
                                    <tbody id="shop-table-body" class="divide-y divide-gray-200 dark:divide-white/10">
                                        <!-- Table rows injected via JS -->
                                    </tbody>
                                </table>
                            </div>
                        </div>
                    </div>

                </div>
            </main>
        </div>
    </div>

    <!-- CREATE SHOP VIEW (Standalone) -->
    <div id="view-create-shop" class="view-section bg-background-light dark:bg-background-dark min-h-screen">
        <div class="max-w-4xl mx-auto p-8">
            <header class="mb-8">
                <div class="flex items-center gap-2 text-sm text-gray-500 dark:text-gray-400 mb-4">
                    <a href="#" onclick="switchView('view-dashboard')" class="hover:text-primary">Dashboard</a>
                    <span>/</span>
                    <span class="text-gray-900 dark:text-white">Create New Shop</span>
                </div>
                <h1 class="text-3xl font-bold text-gray-900 dark:text-white">Create Your New Shop</h1>
            </header>

            <form onsubmit="handleCreateShop(event)" class="grid grid-cols-1 lg:grid-cols-3 gap-8">
                <div class="lg:col-span-2 flex flex-col gap-6">
                    <div class="bg-white dark:bg-[#111418] p-6 rounded-xl border border-gray-200 dark:border-gray-800">
                        <h2 class="text-lg font-bold text-gray-900 dark:text-white mb-6">Shop Details</h2>
                        <div class="space-y-6">
                            <div>
                                <label class="block text-sm font-medium text-gray-700 dark:text-gray-300 mb-2">Shop Name</label>
                                <input type="text" name="shop_name" required class="w-full rounded-lg border-gray-300 dark:border-gray-700 bg-white dark:bg-gray-800 text-gray-900 dark:text-white h-12 px-4" placeholder="e.g. My Awesome Store">
                            </div>
                            <div>
                                <label class="block text-sm font-medium text-gray-700 dark:text-gray-300 mb-2">Admin Email</label>
                                <input type="email" name="admin_email" required class="w-full rounded-lg border-gray-300 dark:border-gray-700 bg-white dark:bg-gray-800 text-gray-900 dark:text-white h-12 px-4" placeholder="admin@yourstore.com">
                            </div>
                            <div>
                                <label class="block text-sm font-medium text-gray-700 dark:text-gray-300 mb-2">Admin Password (min 8 chars)</label>
                                <input type="password" name="admin_password" required minlength="8" class="w-full rounded-lg border-gray-300 dark:border-gray-700 bg-white dark:bg-gray-800 text-gray-900 dark:text-white h-12 px-4" placeholder="Strong password">
                            </div>
                        </div>
                    </div>
                </div>

                <div class="lg:col-span-1 space-y-4">
                    <div class="bg-primary/5 dark:bg-primary/10 p-6 rounded-xl border border-primary/20">
                        <h3 class="font-bold text-primary mb-2">Ready to Launch?</h3>
                        <button type="submit" class="w-full py-3 rounded-lg bg-primary text-white font-bold hover:bg-primary/90 shadow-lg shadow-primary/20">Create Shop</button>
                        <button type="button" onclick="switchView('view-dashboard')" class="w-full mt-3 py-3 rounded-lg border border-gray-300 dark:border-gray-700 text-gray-600 dark:text-gray-300 font-medium hover:bg-gray-50 dark:hover:bg-gray-800">Cancel</button>
                    </div>
                </div>
            </form>
        </div>
    </div>

    <!-- SHOP DETAILS VIEW (Standalone) -->
    <div id="view-shop-details" class="view-section bg-background-light dark:bg-background-dark min-h-screen">
        <!-- (Same layout structure as dashboard but different content) -->
         <div class="flex min-h-screen">
             <aside class="hidden md:flex w-64 flex-col bg-white dark:bg-[#111418] border-r border-gray-200 dark:border-gray-800 p-4 fixed h-full">
                 <div class="flex items-center gap-2 mb-8 px-2">
                    <span class="material-symbols-outlined text-primary text-3xl">store</span>
                    <span class="text-2xl font-bold text-gray-900 dark:text-white">ShopSaaS</span>
                </div>
                <div class="flex flex-col gap-2 flex-1">
                    <a onclick="switchView('view-dashboard')" class="cursor-pointer flex items-center gap-3 px-3 py-2 rounded-lg hover:bg-gray-100 dark:hover:bg-gray-800 text-gray-600 dark:text-gray-300">
                        <span class="material-symbols-outlined">dashboard</span><p class="text-sm font-medium">Dashboard</p>
                    </a>
                     <a onclick="switchView('view-shop-list')" class="cursor-pointer flex items-center gap-3 px-3 py-2 rounded-lg hover:bg-gray-100 dark:hover:bg-gray-800 text-gray-600 dark:text-gray-300">
                        <span class="material-symbols-outlined">storefront</span><p class="text-sm font-medium">My Shops</p>
                    </a>
                </div>
             </aside>
             <main class="flex-1 p-8 md:ml-64">
                <div class="max-w-5xl mx-auto">
                    <div class="mb-4 flex items-center gap-2 text-sm">
                        <a onclick="switchView('view-shop-list')" class="cursor-pointer text-gray-500 hover:text-primary">Shops</a>
                        <span class="material-symbols-outlined text-sm text-gray-400">chevron_right</span>
                        <span id="detail-shop-name-crumb" class="font-medium text-gray-900 dark:text-white">Shop Name</span>
                    </div>
                    <div class="mb-8 flex flex-wrap items-center justify-between gap-4">
                        <div class="flex items-center gap-4">
                            <h1 id="detail-shop-name" class="text-3xl font-bold text-gray-900 dark:text-white">Shop Name</h1>
                            <span id="detail-shop-status" class="px-2.5 py-0.5 rounded-full text-xs font-semibold bg-gray-100 text-gray-800">Status</span>
                        </div>
                        <div class="flex gap-2">
                            <a id="detail-shop-link" href="#" target="_blank" class="flex items-center gap-2 px-4 py-2 rounded-lg border border-gray-300 dark:border-gray-700 bg-white dark:bg-gray-800 text-gray-700 dark:text-white hover:bg-gray-50 dark:hover:bg-gray-700 font-medium">
                                <span class="material-symbols-outlined text-base">visibility</span> Visit
                            </a>
                            <a id="detail-admin-link" href="#" target="_blank" class="flex items-center gap-2 px-4 py-2 rounded-lg bg-primary text-white hover:bg-primary/90 font-medium">
                                <span class="material-symbols-outlined text-base">admin_panel_settings</span> Admin Panel
                            </a>
                        </div>
                    </div>
                    <div class="grid grid-cols-1 lg:grid-cols-3 gap-8">
                        <div class="lg:col-span-2 space-y-6">
                            <div class="bg-white dark:bg-[#111418] rounded-xl border border-gray-200 dark:border-gray-800 p-5 space-y-4">
                                <div><label class="text-xs font-medium text-gray-500 uppercase">App Name</label><p id="detail-app-name" class="text-base text-gray-900 dark:text-white font-mono mt-1">app-name</p></div>
                                <div><label class="text-xs font-medium text-gray-500 uppercase">Domain</label><p id="detail-domain" class="text-base text-gray-900 dark:text-white mt-1">...</p></div>
                                <div><label class="text-xs font-medium text-gray-500 uppercase">Created At</label><p id="detail-created" class="text-base text-gray-900 dark:text-white mt-1">...</p></div>
                            </div>
                        </div>
                        <div class="space-y-6">
                             <div class="bg-white dark:bg-[#111418] rounded-xl border border-red-200 dark:border-red-900/30 overflow-hidden">
                                <div class="p-5 border-b border-red-100 dark:border-red-900/30 bg-red-50/50 dark:bg-red-900/10"><h2 class="font-bold text-red-700 dark:text-red-400">Danger Zone</h2></div>
                                <div class="p-5"><button onclick="handleDeleteShop()" class="w-full flex items-center justify-center gap-2 px-4 py-2 rounded-lg bg-destructive text-white hover:bg-red-700 font-medium"><span class="material-symbols-outlined text-base">delete</span> Delete Shop</button></div>
                            </div>
                        </div>
                    </div>
                </div>
             </main>
         </div>
    </div>

    <script>
        // --- GLOBAL STATE & UTILS ---
        let currentUser = null;
        let currentShopId = null;
        let allShops = [];

        function switchView(viewId) {
            // 1. Hide standalone views
            ['view-landing', 'view-auth', 'view-create-shop', 'view-shop-details'].forEach(id => {
                const el = document.getElementById(id);
                if(el) el.classList.remove('active');
            });
            
            // 2. Hide/Show Main App Layout
            const appLayout = document.getElementById('app-layout');
            
            if (viewId === 'view-dashboard' || viewId === 'view-shop-list') {
                appLayout.style.display = 'block';
                // Toggle content inside app layout
                document.getElementById('content-dashboard').style.display = viewId === 'view-dashboard' ? 'block' : 'none';
                document.getElementById('content-shop-list').style.display = viewId === 'view-shop-list' ? 'block' : 'none';
                
                // Update Sidebar Active State
                document.getElementById('nav-dashboard').className = viewId === 'view-dashboard' ? 
                    'cursor-pointer flex items-center gap-3 px-3 py-2 rounded-lg bg-primary/10 dark:bg-primary/20 text-primary nav-item' : 
                    'cursor-pointer flex items-center gap-3 px-3 py-2 rounded-lg hover:bg-gray-100 dark:hover:bg-gray-800 text-gray-600 dark:text-gray-300 nav-item';
                    
                document.getElementById('nav-shops').className = viewId === 'view-shop-list' ? 
                    'cursor-pointer flex items-center gap-3 px-3 py-2 rounded-lg bg-primary/10 dark:bg-primary/20 text-primary nav-item' : 
                    'cursor-pointer flex items-center gap-3 px-3 py-2 rounded-lg hover:bg-gray-100 dark:hover:bg-gray-800 text-gray-600 dark:text-gray-300 nav-item';

                if (viewId === 'view-dashboard') loadDashboard();
                if (viewId === 'view-shop-list') loadShopList();

            } else {
                appLayout.style.display = 'none';
                const target = document.getElementById(viewId);
                if(target) target.classList.add('active');
            }
        }

        function showLoading(show, message = "Loading...") {
            const el = document.getElementById('loading-overlay');
            document.getElementById('loading-message').textContent = message;
            el.style.display = show ? 'flex' : 'none';
        }

        // --- AUTH LOGIC ---
        async function checkAuth() {
            try {
                const res = await fetch('/api/user');
                const data = await res.json();
                if (data.user) {
                    currentUser = data.user;
                    updateUserUI();
                    switchView('view-dashboard');
                } else {
                    switchView('view-landing');
                }
            } catch (e) {
                console.error("Auth check failed", e);
                switchView('view-landing');
            }
        }

        function updateUserUI() {
            if (!currentUser) return;
            document.getElementById('dashboard-user-name').textContent = currentUser.name || 'User';
            document.getElementById('dashboard-user-email').textContent = currentUser.email;
            document.getElementById('user-avatar').textContent = (currentUser.name || currentUser.email)[0].toUpperCase();
        }

        async function handlePasswordLogin(e) {
            e.preventDefault();
            showLoading(true, "Signing in...");
            const email = document.getElementById('login-email').value;
            const password = document.getElementById('login-password').value;
            
            try {
                const res = await fetch('/auth/password/login', {
                    method: 'POST', headers: {'Content-Type': 'application/json'},
                    body: JSON.stringify({email, password})
                });
                if (res.ok) {
                    checkAuth();
                } else {
                    const d = await res.json();
                    alert(d.error || 'Login failed');
                }
            } catch (err) {
                alert('Login error: ' + err.message);
            } finally {
                showLoading(false);
            }
        }
        
        async function handleRegister() { /* Reuse previous implementation */ 
             const name = prompt('Your Name'); const email = prompt('Email'); const password = prompt('Password (min 8 chars)');
             if(!email || !password) return;
             showLoading(true, "Creating account...");
             try { const res = await fetch('/auth/password/register', { method: 'POST', headers: {'Content-Type': 'application/json'}, body: JSON.stringify({email, password, name}) });
             if (res.ok) alert('Account created! Please sign in.'); else { const d = await res.json(); alert(d.error || 'Failed'); } } catch (e) { alert(e.message); } finally { showLoading(false); }
        }

        async function logout() {
            await fetch('/auth/logout', { method: 'POST' });
            currentUser = null;
            switchView('view-landing');
        }

        // --- DATA LOADING ---
        async function fetchShops() {
            try {
                const res = await fetch('/api/shops');
                const data = await res.json();
                allShops = (data.shops || []).filter(s => s.status !== 'deleted');
                
                // Also update credits
                fetch('/api/billing/summary').then(r => r.json()).then(d => {
                    document.getElementById('dashboard-credits').textContent = d.credits || 0;
                });
                
                return allShops;
            } catch (e) {
                console.error(e);
                return [];
            }
        }

        // --- DASHBOARD VIEW LOGIC ---
        async function loadDashboard() {
            const shops = await fetchShops();
            renderDashboardGrid(shops.slice(0, 6)); // Show first 6
        }

        function renderDashboardGrid(shops) {
            const container = document.getElementById('dashboard-shops-grid');
            if (shops.length === 0) {
                container.innerHTML = '<div class="col-span-full text-gray-500">No shops found.</div>';
                return;
            }
            container.innerHTML = shops.map(shop => `
                <div class="flex flex-col gap-4 p-6 bg-white dark:bg-[#111418] border border-gray-200 dark:border-gray-800 rounded-xl hover:shadow-md transition-all">
                    <div class="flex items-center gap-3">
                        <div class="size-12 rounded-lg bg-primary/10 flex items-center justify-center text-primary text-xl font-bold">${shop.shop_name.substring(0,2).toUpperCase()}</div>
                        <div class="flex-1 min-w-0">
                            <p class="text-gray-900 dark:text-white text-base font-bold truncate">${shop.shop_name}</p>
                            <p class="text-gray-500 dark:text-gray-400 text-xs truncate">${shop.app_name}.fly.dev</p>
                        </div>
                        <span class="inline-flex items-center rounded-full px-2.5 py-0.5 text-xs font-medium ${getStatusColor(shop.status)}">${shop.status}</span>
                    </div>
                    <div class="flex gap-2 mt-auto pt-4">
                        <button onclick="openShopDetails(${shop.id})" class="flex-1 h-9 px-3 text-sm font-bold rounded-lg bg-gray-100 dark:bg-gray-800 text-gray-800 dark:text-gray-200 hover:bg-gray-200 dark:hover:bg-gray-700">Manage</button>
                        <a href="https://${shop.app_name}.fly.dev" target="_blank" class="flex-1 h-9 flex items-center justify-center px-3 text-sm font-bold rounded-lg bg-primary/10 text-primary hover:bg-primary/20">Visit</a>
                    </div>
                </div>
            `).join('');
        }

        // --- SHOP LIST VIEW LOGIC ---
        async function loadShopList() {
            const shops = await fetchShops();
            renderShopTable(shops);
        }

        function renderShopTable(shops) {
            const tbody = document.getElementById('shop-table-body');
            if (shops.length === 0) {
                tbody.innerHTML = '<tr><td colspan="4" class="px-6 py-4 text-center text-gray-500">No shops found.</td></tr>';
                return;
            }
            tbody.innerHTML = shops.map(shop => `
                <tr class="hover:bg-gray-50 dark:hover:bg-white/5 transition-colors">
                    <td class="table-col-shop-name px-6 py-4 text-sm font-medium text-gray-900 dark:text-white">
                        <div class="flex items-center gap-3">
                            <div class="size-8 rounded bg-primary/10 flex items-center justify-center text-primary font-bold text-xs">${shop.shop_name.substring(0,1)}</div>
                            <div>
                                <p>${shop.shop_name}</p>
                                <p class="text-xs text-gray-500">${shop.app_name}</p>
                            </div>
                        </div>
                    </td>
                    <td class="table-col-status px-6 py-4 text-sm">
                        <span class="inline-flex items-center gap-2 rounded-full px-2.5 py-0.5 text-xs font-medium ${getStatusColor(shop.status)}">
                            <span class="size-1.5 rounded-full bg-current"></span> ${shop.status}
                        </span>
                    </td>
                    <td class="table-col-updated px-6 py-4 text-sm text-gray-500 dark:text-gray-400">
                        ${new Date(shop.created_at).toLocaleDateString()}
                    </td>
                    <td class="table-col-actions px-6 py-4 text-sm">
                        <div class="flex items-center gap-2">
                            <button onclick="openShopDetails(${shop.id})" class="p-1.5 rounded text-gray-500 hover:bg-gray-100 dark:hover:bg-white/10 hover:text-primary" title="View Details"><span class="material-symbols-outlined text-lg">visibility</span></button>
                            <a href="https://${shop.app_name}.fly.dev" target="_blank" class="p-1.5 rounded text-gray-500 hover:bg-gray-100 dark:hover:bg-white/10 hover:text-primary" title="Visit Shop"><span class="material-symbols-outlined text-lg">open_in_new</span></a>
                            <button onclick="confirmDelete(${shop.id})" class="p-1.5 rounded text-gray-500 hover:bg-gray-100 dark:hover:bg-white/10 hover:text-destructive" title="Delete"><span class="material-symbols-outlined text-lg">delete</span></button>
                        </div>
                    </td>
                </tr>
            `).join('');
        }

        function filterShops() {
            const query = document.getElementById('shop-search').value.toLowerCase();
            const filtered = allShops.filter(s => s.shop_name.toLowerCase().includes(query) || s.app_name.toLowerCase().includes(query));
            renderShopTable(filtered);
        }
        
        function confirmDelete(id) {
            currentShopId = id;
            handleDeleteShop();
        }

        function getStatusColor(status) {
            if (status === 'active') return 'bg-green-100 text-green-800 dark:bg-green-900/50 dark:text-green-300';
            if (status === 'creating') return 'bg-yellow-100 text-yellow-800 dark:bg-yellow-900/50 dark:text-yellow-300';
            return 'bg-gray-100 text-gray-800 dark:bg-gray-800 dark:text-gray-300';
        }

        // --- CREATE & DETAILS ---
        async function handleCreateShop(e) { /* Same as before */ 
            e.preventDefault(); const formData = new FormData(e.target); const data = Object.fromEntries(formData.entries());
            showLoading(true, "Provisioning shop...");
            try { const res = await fetch('/api/shops', { method: 'POST', headers: {'Content-Type': 'application/json'}, body: JSON.stringify(data) });
            const r = await res.json(); if(res.ok) { alert('Shop creation started!'); e.target.reset(); switchView('view-dashboard'); } else throw new Error(r.error);
            } catch(err) { alert(err.message); } finally { showLoading(false); }
        }

        async function openShopDetails(shopId) { /* Same as before */
            currentShopId = shopId; showLoading(true);
            try { const res = await fetch(`/api/shops/${shopId}/status`); if(!res.ok) throw new Error("Failed"); const d = await res.json(); renderShopDetails(d.shop); switchView('view-shop-details'); } catch(e) { alert(e.message); } finally { showLoading(false); }
        }

        function renderShopDetails(shop) { /* Same as before */
            document.getElementById('detail-shop-name').textContent = shop.shop_name;
            document.getElementById('detail-shop-name-crumb').textContent = shop.shop_name;
            document.getElementById('detail-app-name').textContent = shop.app_name;
            document.getElementById('detail-domain').textContent = shop.domain || `${shop.app_name}.fly.dev`;
            document.getElementById('detail-created').textContent = new Date(shop.created_at).toLocaleString();
            document.getElementById('detail-shop-status').textContent = shop.status;
            document.getElementById('detail-shop-status').className = `px-2.5 py-0.5 rounded-full text-xs font-semibold ${getStatusColor(shop.status)}`;
            document.getElementById('detail-shop-link').href = `https://${shop.domain || shop.app_name + '.fly.dev'}`;
            document.getElementById('detail-admin-link').href = `https://${shop.domain || shop.app_name + '.fly.dev'}/admin`;
        }

        async function handleDeleteShop() { /* Same as before */
            if(!confirm("Delete this shop?")) return; showLoading(true);
            try { const res = await fetch(`/api/shops/${currentShopId}`, {method:'DELETE'}); if(res.ok) { alert('Deleted'); switchView('view-dashboard'); } else alert('Failed'); } catch(e) { alert(e.message); } finally { showLoading(false); }
        }

        // Init
        checkAuth();

    </script>
</body>
</html>
