<!DOCTYPE html>
<html class="dark" lang="en">
<head>
    <meta charset="utf-8"/>
    <meta content="width=device-width, initial-scale=1.0" name="viewport"/>
    <title>Shops - DrSell</title>
    <script src="https://cdn.tailwindcss.com?plugins=forms,container-queries"></script>
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;700;900&display=swap" rel="stylesheet"/>
    <link href="https://fonts.googleapis.com/css2?family=Material+Symbols+Outlined" rel="stylesheet"/>
    <style>
        .material-symbols-outlined {
            font-variation-settings: 'FILL' 0, 'wght' 400, 'GRAD' 0, 'opsz' 24
        }
    </style>
    <script id="tailwind-config">
        tailwind.config = {
            darkMode: "class",
            theme: {
                extend: {
                    colors: {
                        "primary": "#137fec",
                        "background-light": "#f6f7f8",
                        "background-dark": "#101922",
                    },
                    fontFamily: {
                        "display": ["Inter", "sans-serif"]
                    },
                    borderRadius: {"DEFAULT": "0.25rem", "lg": "0.5rem", "xl": "0.75rem", "full": "9999px"},
                },
            },
        }
    </script>
</head>
<body class="bg-background-light dark:bg-background-dark font-display">
<div class="flex min-h-screen">
    <!-- SideNavBar -->
    <aside class="flex w-64 flex-col bg-white dark:bg-[#111418] border-r border-gray-200 dark:border-gray-800 p-4">
        <div class="flex items-center gap-2 mb-8 cursor-pointer" onclick="window.location.href='/'">
            <span class="material-symbols-outlined text-primary text-3xl">store</span>
            <span class="text-2xl font-bold text-gray-900 dark:text-white">DrSell</span>
        </div>
        <div class="flex flex-col gap-4 flex-1">
            <div class="flex flex-col gap-2">
                <a class="flex items-center gap-3 px-3 py-2 text-gray-600 dark:text-gray-300 hover:bg-gray-100 dark:hover:bg-gray-800 rounded-lg" href="/dashboard">
                    <span class="material-symbols-outlined">dashboard</span>
                    <p class="text-sm font-medium" data-i18n="nav_dashboard">Dashboard</p>
                </a>
                <a class="flex items-center gap-3 px-3 py-2 rounded-lg bg-primary/10 dark:bg-primary/20 text-primary" href="/shops">
                    <span class="material-symbols-outlined">storefront</span>
                    <p class="text-sm font-medium" data-i18n="nav_shops">Shops</p>
                </a>
                <a class="flex items-center gap-3 px-3 py-2 text-gray-600 dark:text-gray-300 hover:bg-gray-100 dark:hover:bg-gray-800 rounded-lg" href="/billing">
                    <span class="material-symbols-outlined">credit_card</span>
                    <p class="text-sm font-medium" data-i18n="nav_billing">Billing</p>
                </a>
                <a class="flex items-center gap-3 px-3 py-2 text-gray-600 dark:text-gray-300 hover:bg-gray-100 dark:hover:bg-gray-800 rounded-lg" href="/ai-assistant">
                    <span class="material-symbols-outlined">smart_toy</span>
                    <p class="text-sm font-medium" data-i18n="nav_ai_assistant">AI Assistant</p>
                </a>
            </div>
        </div>
        <div class="flex gap-3 items-center border-t border-gray-200 dark:border-gray-800 pt-4">
            <div class="bg-center bg-no-repeat aspect-square bg-cover rounded-full size-10" style='background-image: url("media/dashboard-avatar.png");'></div>
            <div class="flex flex-col overflow-hidden">
                <h1 id="user-name-display" class="text-gray-900 dark:text-white text-base font-medium leading-normal truncate">User</h1>
                <p id="user-email-display" class="text-gray-500 dark:text-gray-400 text-sm font-normal leading-normal truncate">loading...</p>
            </div>
            <button onclick="logout()" class="ml-auto text-gray-500 hover:text-red-500" title="Logout">
                <span class="material-symbols-outlined" data-i18n-title="logout_title">logout</span>
            </button>
        </div>
    </aside>

    <!-- Main Content -->
    <main class="flex-1 p-8">
        <div class="max-w-7xl mx-auto">
            <!-- PageHeading -->
            <div class="flex flex-wrap justify-between items-center gap-4 mb-8">
                <div>
                    <p class="text-gray-900 dark:text-white text-4xl font-black leading-tight tracking-[-0.033em]" data-i18n="shops_title">Your Shops</p>
                    <p class="text-gray-500 dark:text-gray-400 text-base mt-2" data-i18n="shops_subtitle">Manage and monitor all your online stores</p>
                </div>
                <div class="flex items-center gap-4">
                    <button onclick="toggleLanguage()" class="flex items-center justify-center gap-2 h-10 px-4 rounded-lg bg-gray-100 dark:bg-gray-800 text-gray-800 dark:text-gray-200 hover:bg-gray-200 dark:hover:bg-gray-700 transition-colors">
                        <span class="material-symbols-outlined">language</span>
                        <span id="lang-label">EN</span>
                    </button>
                    <button onclick="window.location.href='/dashboard'" class="flex min-w-[84px] cursor-pointer items-center justify-center gap-2 overflow-hidden rounded-lg h-10 px-4 bg-primary text-white text-sm font-bold leading-normal tracking-[0.015em] hover:bg-primary/90 transition-colors shadow-md">
                        <span class="material-symbols-outlined">add_circle</span>
                        <span class="truncate" data-i18n="add_new_shop">Add New Shop</span>
                    </button>
                </div>
            </div>

            <!-- Shops Grid -->
            <div id="shops-container" class="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-3 gap-6">
                <!-- Loading state -->
                <div class="col-span-full flex items-center justify-center py-12">
                    <div class="text-gray-500 dark:text-gray-400" data-i18n="loading_shops">Loading shops...</div>
                </div>
            </div>
        </div>
    </main>
</div>

<!-- Shop Details Modal -->
<div id="shop-modal" class="hidden fixed inset-0 bg-black bg-opacity-50 flex items-center justify-center z-50">
    <div class="bg-white dark:bg-[#111418] rounded-lg shadow-lg max-w-md w-full mx-4">
        <div class="p-6 border-b border-gray-200 dark:border-gray-800">
            <h2 id="modal-shop-name" class="text-xl font-bold text-gray-900 dark:text-white">Shop Details</h2>
        </div>
        <div class="p-6 space-y-4">
            <div>
                <p class="text-sm text-gray-500 dark:text-gray-400" data-i18n="shop_url">Shop URL</p>
                <p id="modal-shop-url" class="text-gray-900 dark:text-white font-medium break-all">-</p>
            </div>
            <div>
                <p class="text-sm text-gray-500 dark:text-gray-400" data-i18n="shop_status">Status</p>
                <div class="flex items-center gap-2 mt-1">
                    <span id="modal-shop-status-badge" class="inline-block px-3 py-1 rounded-full text-sm font-medium">Active</span>
                </div>
            </div>
            <div>
                <p class="text-sm text-gray-500 dark:text-gray-400" data-i18n="created_date">Created Date</p>
                <p id="modal-shop-created" class="text-gray-900 dark:text-white">-</p>
            </div>
        </div>
        <div class="p-6 border-t border-gray-200 dark:border-gray-800 flex gap-3">
            <button onclick="closeModal()" class="flex-1 px-4 py-2 rounded-lg border border-gray-200 dark:border-gray-800 text-gray-900 dark:text-white hover:bg-gray-50 dark:hover:bg-gray-800 transition-colors">
                <span data-i18n="btn_close">Close</span>
            </button>
            <button onclick="deleteShop()" class="flex-1 px-4 py-2 rounded-lg bg-red-500 text-white hover:bg-red-600 transition-colors">
                <span data-i18n="btn_delete">Delete</span>
            </button>
        </div>
    </div>
</div>

<script>
    // --- I18n Configuration ---
    let currentLang = localStorage.getItem('preferredLang') || 'en';

    const translations = {
        en: {
            nav_dashboard: "Dashboard",
            nav_shops: "Shops",
            nav_billing: "Billing",
            nav_ai_assistant: "AI Assistant",
            logout_title: "Logout",
            shops_title: "Your Shops",
            shops_subtitle: "Manage and monitor all your online stores",
            add_new_shop: "Add New Shop",
            loading_shops: "Loading shops...",
            shop_url: "Shop URL",
            shop_status: "Status",
            created_date: "Created Date",
            btn_close: "Close",
            btn_delete: "Delete",
            status_active: "Active",
            status_deploying: "Deploying",
            status_failed: "Failed",
            no_shops: "No shops found. Create your first shop to get started!"
        },
        zh: {
            nav_dashboard: "仪表盘",
            nav_shops: "店铺管理",
            nav_billing: "计费中心",
            nav_ai_assistant: "AI 助手",
            logout_title: "登出",
            shops_title: "我的店铺",
            shops_subtitle: "管理和监控您的所有在线商店",
            add_new_shop: "创建新店铺",
            loading_shops: "加载店铺中...",
            shop_url: "店铺链接",
            shop_status: "状态",
            created_date: "创建日期",
            btn_close: "关闭",
            btn_delete: "删除",
            status_active: "活跃",
            status_deploying: "部署中",
            status_failed: "失败",
            no_shops: "暂无店铺。创建您的第一个店铺开始!"
        }
    };

    function _t(key) {
        return translations[currentLang][key] || key;
    }

    function toggleLanguage() {
        currentLang = currentLang === 'en' ? 'zh' : 'en';
        localStorage.setItem('preferredLang', currentLang);
        updateContent();
    }

    function updateContent() {
        document.getElementById('lang-label').textContent = currentLang === 'en' ? 'EN' : '中';
        document.querySelectorAll('[data-i18n]').forEach(el => {
            const key = el.getAttribute('data-i18n');
            if (translations[currentLang][key]) {
                el.textContent = translations[currentLang][key];
            }
        });
        loadShops();
    }

    // --- State & Logic ---
    let currentShopId = null;

    async function ensureAuth() {
        try {
            const response = await fetch('/api/user');
            if (!response.ok) {
                window.location.href = '/login.html';
                return;
            }
            const user = await response.json();
            document.getElementById('user-email-display').textContent = user.email;
            document.getElementById('user-name-display').textContent = user.name || user.email.split('@')[0];
        } catch (error) {
            console.error('Auth check failed:', error);
            window.location.href = '/login.html';
        }
    }

    async function loadShops() {
        try {
            const response = await fetch('/api/shops');
            if (!response.ok) throw new Error('Failed to load shops');
            const shops = await response.json();

            const container = document.getElementById('shops-container');
            if (!shops || shops.length === 0) {
                container.innerHTML = `<div class="col-span-full text-center py-12 text-gray-500 dark:text-gray-400">${_t('no_shops')}</div>`;
                return;
            }

            container.innerHTML = shops.map(shop => {
                const statusColor = shop.status === 'active'
                    ? 'bg-green-100 text-green-800 dark:bg-green-900 dark:text-green-300'
                    : shop.status === 'deploying'
                    ? 'bg-yellow-100 text-yellow-800 dark:bg-yellow-900 dark:text-yellow-300'
                    : 'bg-red-100 text-red-800 dark:bg-red-900 dark:text-red-300';

                const statusLabel = _t(`status_${shop.status}`);

                return `
                <div class="bg-white dark:bg-[#111418] rounded-lg border border-gray-200 dark:border-gray-800 overflow-hidden shadow-sm hover:shadow-md transition-shadow">
                    <div class="h-32 bg-gradient-to-br from-primary/10 to-primary/5"></div>
                    <div class="p-6">
                        <div class="flex items-start justify-between mb-4">
                            <h3 class="text-lg font-bold text-gray-900 dark:text-white">${escapeHtml(shop.name)}</h3>
                            <span class="px-2 py-1 text-xs font-medium rounded ${statusColor}">${statusLabel}</span>
                        </div>
                        <p class="text-sm text-gray-500 dark:text-gray-400 mb-4 break-all">${escapeHtml(shop.url || '-')}</p>
                        <button onclick="showShopModal('${escapeHtml(shop.id)}', '${escapeHtml(shop.name)}', '${escapeHtml(shop.url || '')}', '${shop.status}', '${new Date(shop.created_at).toLocaleDateString()}')"
                            class="w-full px-4 py-2 rounded-lg bg-primary text-white text-sm font-medium hover:bg-primary/90 transition-colors">
                            ${_t('btn_close')}
                        </button>
                    </div>
                </div>
                `;
            }).join('');
        } catch (error) {
            console.error('Error loading shops:', error);
            document.getElementById('shops-container').innerHTML = `<div class="col-span-full text-red-500">${error.message}</div>`;
        }
    }

    function showShopModal(id, name, url, status, created) {
        currentShopId = id;
        document.getElementById('modal-shop-name').textContent = name;
        document.getElementById('modal-shop-url').textContent = url;
        document.getElementById('modal-shop-created').textContent = created;

        const statusColor = status === 'active'
            ? 'bg-green-100 text-green-800 dark:bg-green-900 dark:text-green-300'
            : status === 'deploying'
            ? 'bg-yellow-100 text-yellow-800 dark:bg-yellow-900 dark:text-yellow-300'
            : 'bg-red-100 text-red-800 dark:bg-red-900 dark:text-red-300';

        const badge = document.getElementById('modal-shop-status-badge');
        badge.textContent = _t(`status_${status}`);
        badge.className = `inline-block px-3 py-1 rounded-full text-sm font-medium ${statusColor}`;

        document.getElementById('shop-modal').classList.remove('hidden');
    }

    function closeModal() {
        document.getElementById('shop-modal').classList.add('hidden');
        currentShopId = null;
    }

    async function deleteShop() {
        if (!currentShopId) return;
        if (!confirm('Are you sure you want to delete this shop?')) return;

        try {
            const response = await fetch(`/api/shops/${currentShopId}`, {
                method: 'DELETE'
            });
            if (!response.ok) throw new Error('Failed to delete shop');

            closeModal();
            loadShops();
        } catch (error) {
            console.error('Error deleting shop:', error);
            alert('Failed to delete shop: ' + error.message);
        }
    }

    function escapeHtml(text) {
        const div = document.createElement('div');
        div.textContent = text;
        return div.innerHTML;
    }

    async function logout() {
        try {
            await fetch('/auth/logout', { method: 'POST' });
        } catch (error) {
            console.error('Logout error:', error);
        }
        window.location.href = '/login.html';
    }

    // Init
    (async function init() {
        await ensureAuth();
        updateContent();
    })();
</script>
</body>
</html>
