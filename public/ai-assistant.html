<!DOCTYPE html>
<html class="dark" lang="en">
<head>
    <meta charset="utf-8"/>
    <meta content="width=device-width, initial-scale=1.0" name="viewport"/>
    <title>AI Assistant - DrSell</title>
    <script src="https://cdn.tailwindcss.com?plugins=forms,container-queries"></script>
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;700;900&display=swap" rel="stylesheet"/>
    <link href="https://fonts.googleapis.com/css2?family=Material+Symbols+Outlined" rel="stylesheet"/>
    <style>
        .material-symbols-outlined {
            font-variation-settings: 'FILL' 0, 'wght' 400, 'GRAD' 0, 'opsz' 24
        }
    </style>
    <script id="tailwind-config">
        tailwind.config = {
            darkMode: "class",
            theme: {
                extend: {
                    colors: {
                        "primary": "#137fec",
                        "background-light": "#f6f7f8",
                        "background-dark": "#101922",
                    },
                    fontFamily: {
                        "display": ["Inter", "sans-serif"]
                    },
                    borderRadius: {"DEFAULT": "0.25rem", "lg": "0.5rem", "xl": "0.75rem", "full": "9999px"},
                },
            },
        }
    </script>
</head>
<body class="bg-background-light dark:bg-background-dark font-display">
<div class="flex min-h-screen">
    <!-- SideNavBar -->
    <aside class="flex w-64 flex-col bg-white dark:bg-[#111418] border-r border-gray-200 dark:border-gray-800 p-4">
        <div class="flex items-center gap-2 mb-8 cursor-pointer" onclick="window.location.href='/'">
            <span class="material-symbols-outlined text-primary text-3xl">store</span>
            <span class="text-2xl font-bold text-gray-900 dark:text-white">DrSell</span>
        </div>
        <div class="flex flex-col gap-4 flex-1">
            <div class="flex flex-col gap-2">
                <a class="flex items-center gap-3 px-3 py-2 text-gray-600 dark:text-gray-300 hover:bg-gray-100 dark:hover:bg-gray-800 rounded-lg" href="/dashboard">
                    <span class="material-symbols-outlined">dashboard</span>
                    <p class="text-sm font-medium" data-i18n="nav_dashboard">Dashboard</p>
                </a>
                <a class="flex items-center gap-3 px-3 py-2 text-gray-600 dark:text-gray-300 hover:bg-gray-100 dark:hover:bg-gray-800 rounded-lg" href="/shops">
                    <span class="material-symbols-outlined">storefront</span>
                    <p class="text-sm font-medium" data-i18n="nav_shops">Shops</p>
                </a>
                <a class="flex items-center gap-3 px-3 py-2 text-gray-600 dark:text-gray-300 hover:bg-gray-100 dark:hover:bg-gray-800 rounded-lg" href="/billing">
                    <span class="material-symbols-outlined">credit_card</span>
                    <p class="text-sm font-medium" data-i18n="nav_billing">Billing</p>
                </a>
                <a class="flex items-center gap-3 px-3 py-2 rounded-lg bg-primary/10 dark:bg-primary/20 text-primary" href="/ai-assistant">
                    <span class="material-symbols-outlined">smart_toy</span>
                    <p class="text-sm font-medium" data-i18n="nav_ai_assistant">AI Assistant</p>
                </a>
            </div>
        </div>
        <div class="flex gap-3 items-center border-t border-gray-200 dark:border-gray-800 pt-4">
            <div class="bg-center bg-no-repeat aspect-square bg-cover rounded-full size-10" style='background-image: url("media/dashboard-avatar.png");'></div>
            <div class="flex flex-col overflow-hidden">
                <h1 id="user-name-display" class="text-gray-900 dark:text-white text-base font-medium leading-normal truncate">User</h1>
                <p id="user-email-display" class="text-gray-500 dark:text-gray-400 text-sm font-normal leading-normal truncate">loading...</p>
            </div>
            <button onclick="logout()" class="ml-auto text-gray-500 hover:text-red-500" title="Logout">
                <span class="material-symbols-outlined" data-i18n-title="logout_title">logout</span>
            </button>
        </div>
    </aside>

    <!-- Main Content -->
    <main class="flex-1 p-8">
        <div class="max-w-7xl mx-auto">
            <!-- PageHeading -->
            <div class="flex flex-wrap justify-between items-center gap-4 mb-8">
                <div>
                    <p class="text-gray-900 dark:text-white text-4xl font-black leading-tight tracking-[-0.033em]" data-i18n="ai_assistant_title">AI Assistant</p>
                    <p class="text-gray-500 dark:text-gray-400 text-base mt-2" data-i18n="ai_assistant_subtitle">Manage AI-powered customer support for your shops</p>
                </div>
                <div class="flex items-center gap-4">
                    <button onclick="toggleLanguage()" class="flex items-center justify-center gap-2 h-10 px-4 rounded-lg bg-gray-100 dark:bg-gray-800 text-gray-800 dark:text-gray-200 hover:bg-gray-200 dark:hover:bg-gray-700 transition-colors">
                        <span class="material-symbols-outlined">language</span>
                        <span id="lang-label">EN</span>
                    </button>
                </div>
            </div>

            <!-- Overview Stats -->
            <div class="grid grid-cols-1 md:grid-cols-3 gap-6 mb-8">
                <!-- Active Assistants -->
                <div class="bg-white dark:bg-[#111418] rounded-lg border border-gray-200 dark:border-gray-800 p-6 shadow-sm">
                    <div class="flex items-center justify-between mb-4">
                        <div>
                            <p class="text-gray-500 dark:text-gray-400 text-sm" data-i18n="active_assistants">Active Assistants</p>
                            <p id="active-count" class="text-3xl font-bold text-gray-900 dark:text-white mt-2">-</p>
                        </div>
                        <span class="material-symbols-outlined text-primary text-4xl">smart_toy</span>
                    </div>
                </div>

                <!-- Total Conversations -->
                <div class="bg-white dark:bg-[#111418] rounded-lg border border-gray-200 dark:border-gray-800 p-6 shadow-sm">
                    <div class="flex items-center justify-between mb-4">
                        <div>
                            <p class="text-gray-500 dark:text-gray-400 text-sm" data-i18n="total_conversations">Total Conversations</p>
                            <p id="conversations-count" class="text-3xl font-bold text-gray-900 dark:text-white mt-2">-</p>
                        </div>
                        <span class="material-symbols-outlined text-green-500 text-4xl">chat</span>
                    </div>
                </div>

                <!-- Avg Response Time -->
                <div class="bg-white dark:bg-[#111418] rounded-lg border border-gray-200 dark:border-gray-800 p-6 shadow-sm">
                    <div class="flex items-center justify-between mb-4">
                        <div>
                            <p class="text-gray-500 dark:text-gray-400 text-sm" data-i18n="avg_response_time">Avg Response Time</p>
                            <p id="response-time" class="text-3xl font-bold text-gray-900 dark:text-white mt-2">-</p>
                        </div>
                        <span class="material-symbols-outlined text-orange-500 text-4xl">schedule</span>
                    </div>
                </div>
            </div>

            <!-- AI Assistants List -->
            <div class="bg-white dark:bg-[#111418] rounded-lg border border-gray-200 dark:border-gray-800 shadow-sm overflow-hidden">
                <div class="p-6 border-b border-gray-200 dark:border-gray-800">
                    <h2 class="text-xl font-bold text-gray-900 dark:text-white" data-i18n="shop_assistants">Shop Assistants</h2>
                </div>
                <div id="assistants-list" class="overflow-x-auto">
                    <table class="w-full text-sm text-left text-gray-500 dark:text-gray-400">
                        <thead class="text-xs text-gray-700 uppercase bg-gray-50 dark:bg-gray-800 dark:text-gray-400">
                        <tr>
                            <th class="px-6 py-3" data-i18n="col_shop">Shop</th>
                            <th class="px-6 py-3" data-i18n="col_status">Status</th>
                            <th class="px-6 py-3" data-i18n="col_conversations">Conversations</th>
                            <th class="px-6 py-3" data-i18n="col_enabled_date">Enabled Date</th>
                            <th class="px-6 py-3" data-i18n="col_actions">Actions</th>
                        </tr>
                        </thead>
                        <tbody>
                            <tr class="bg-white dark:bg-transparent border-b dark:border-gray-800">
                                <td colspan="5" class="px-6 py-8 text-center text-gray-500" data-i18n="loading_assistants">Loading assistants...</td>
                            </tr>
                        </tbody>
                    </table>
                </div>
            </div>

            <!-- Documentation Section -->
            <div class="mt-10 bg-blue-50 dark:bg-blue-900/20 border border-blue-200 dark:border-blue-800 rounded-lg p-6">
                <div class="flex gap-4">
                    <span class="material-symbols-outlined text-blue-600 dark:text-blue-400 text-2xl">info</span>
                    <div>
                        <h3 class="font-bold text-blue-900 dark:text-blue-100 mb-2" data-i18n="ai_info_title">AI Assistant Features</h3>
                        <p class="text-blue-800 dark:text-blue-200 text-sm" data-i18n="ai_info_desc">Enable AI Assistant on your shops to provide 24/7 customer support, answer common questions, and boost customer satisfaction. The AI learns from your products and FAQs.</p>
                    </div>
                </div>
            </div>
        </div>
    </main>
</div>

<script>
    // --- I18n Configuration ---
    let currentLang = localStorage.getItem('preferredLang') || 'en';

    const translations = {
        en: {
            nav_dashboard: "Dashboard",
            nav_shops: "Shops",
            nav_billing: "Billing",
            nav_ai_assistant: "AI Assistant",
            logout_title: "Logout",
            ai_assistant_title: "AI Assistant",
            ai_assistant_subtitle: "Manage AI-powered customer support for your shops",
            active_assistants: "Active Assistants",
            total_conversations: "Total Conversations",
            avg_response_time: "Avg Response Time",
            shop_assistants: "Shop Assistants",
            col_shop: "Shop",
            col_status: "Status",
            col_conversations: "Conversations",
            col_enabled_date: "Enabled Date",
            col_actions: "Actions",
            loading_assistants: "Loading assistants...",
            no_assistants: "No AI assistants enabled. Enable AI Assistant on your shops to get started.",
            status_enabled: "Enabled",
            status_disabled: "Disabled",
            btn_disable: "Disable",
            btn_enable: "Enable",
            ai_info_title: "AI Assistant Features",
            ai_info_desc: "Enable AI Assistant on your shops to provide 24/7 customer support, answer common questions, and boost customer satisfaction. The AI learns from your products and FAQs."
        },
        zh: {
            nav_dashboard: "仪表盘",
            nav_shops: "店铺管理",
            nav_billing: "计费中心",
            nav_ai_assistant: "AI 助手",
            logout_title: "登出",
            ai_assistant_title: "AI 智能助手",
            ai_assistant_subtitle: "管理您的店铺的 AI 客服",
            active_assistants: "活跃助手",
            total_conversations: "总对话数",
            avg_response_time: "平均响应时间",
            shop_assistants: "店铺助手",
            col_shop: "店铺",
            col_status: "状态",
            col_conversations: "对话数",
            col_enabled_date: "启用日期",
            col_actions: "操作",
            loading_assistants: "加载助手中...",
            no_assistants: "暂无启用的 AI 助手。在您的店铺中启用 AI 助手即可开始。",
            status_enabled: "已启用",
            status_disabled: "已禁用",
            btn_disable: "禁用",
            btn_enable: "启用",
            ai_info_title: "AI 智能助手功能",
            ai_info_desc: "在您的店铺中启用 AI 智能助手，为客户提供 24/7 客服支持、回答常见问题并提升客户满意度。AI 会学习您的产品和常见问题。"
        }
    };

    function _t(key) {
        return translations[currentLang][key] || key;
    }

    function toggleLanguage() {
        currentLang = currentLang === 'en' ? 'zh' : 'en';
        localStorage.setItem('preferredLang', currentLang);
        updateContent();
    }

    function updateContent() {
        document.getElementById('lang-label').textContent = currentLang === 'en' ? 'EN' : '中';
        document.querySelectorAll('[data-i18n]').forEach(el => {
            const key = el.getAttribute('data-i18n');
            if (translations[currentLang][key]) {
                el.textContent = translations[currentLang][key];
            }
        });
        loadAssistants();
    }

    // --- State & Logic ---
    async function ensureAuth() {
        try {
            const response = await fetch('/api/user');
            if (!response.ok) {
                window.location.href = '/login.html';
                return;
            }
            const user = await response.json();
            document.getElementById('user-email-display').textContent = user.email;
            document.getElementById('user-name-display').textContent = user.name || user.email.split('@')[0];
        } catch (error) {
            console.error('Auth check failed:', error);
            window.location.href = '/login.html';
        }
    }

    async function loadAssistants() {
        try {
            const response = await fetch('/api/shops');
            if (!response.ok) throw new Error('Failed to load shops');
            const shops = await response.json();

            if (!shops || shops.length === 0) {
                document.querySelector('#assistants-list tbody').innerHTML =
                    `<tr><td colspan="5" class="px-6 py-8 text-center text-gray-500">${_t('no_assistants')}</td></tr>`;
                updateStats(0, 0, 0);
                return;
            }

            // Fetch chatbot status for each shop
            const assistants = await Promise.all(shops.map(async (shop) => {
                try {
                    const response = await fetch(`/api/shops/${shop.id}/chatbot/status`);
                    const status = await response.json();
                    return {
                        id: shop.id,
                        name: shop.name,
                        enabled: status.enabled,
                        created_at: shop.created_at
                    };
                } catch (error) {
                    return {
                        id: shop.id,
                        name: shop.name,
                        enabled: false,
                        created_at: shop.created_at
                    };
                }
            }));

            const enabledCount = assistants.filter(a => a.enabled).length;
            updateStats(enabledCount, assistants.length * 10, '< 1s');

            const tbody = document.querySelector('#assistants-list tbody');
            tbody.innerHTML = assistants.map(asst => `
                <tr class="bg-white dark:bg-transparent border-b dark:border-gray-800 hover:bg-gray-50 dark:hover:bg-gray-800/50">
                    <td class="px-6 py-4 font-medium text-gray-900 dark:text-white">${escapeHtml(asst.name)}</td>
                    <td class="px-6 py-4">
                        <span class="inline-flex items-center px-2.5 py-0.5 rounded-full text-xs font-medium ${asst.enabled ? 'bg-green-100 text-green-800 dark:bg-green-900 dark:text-green-300' : 'bg-gray-100 text-gray-800 dark:bg-gray-800 dark:text-gray-300'}">
                            ${_t(asst.enabled ? 'status_enabled' : 'status_disabled')}
                        </span>
                    </td>
                    <td class="px-6 py-4">-</td>
                    <td class="px-6 py-4">${new Date(asst.created_at).toLocaleDateString()}</td>
                    <td class="px-6 py-4">
                        <button onclick="toggleAssistant('${escapeHtml(asst.id)}', ${asst.enabled})"
                            class="px-3 py-1 rounded text-sm font-medium ${asst.enabled ? 'bg-red-100 text-red-800 hover:bg-red-200 dark:bg-red-900 dark:text-red-300' : 'bg-blue-100 text-blue-800 hover:bg-blue-200 dark:bg-blue-900 dark:text-blue-300'}">
                            ${_t(asst.enabled ? 'btn_disable' : 'btn_enable')}
                        </button>
                    </td>
                </tr>
            `).join('');
        } catch (error) {
            console.error('Error loading assistants:', error);
            document.querySelector('#assistants-list tbody').innerHTML =
                `<tr><td colspan="5" class="px-6 py-8 text-center text-red-500">${error.message}</td></tr>`;
        }
    }

    function updateStats(active, conversations, responseTime) {
        document.getElementById('active-count').textContent = active;
        document.getElementById('conversations-count').textContent = conversations;
        document.getElementById('response-time').textContent = responseTime;
    }

    async function toggleAssistant(shopId, currentlyEnabled) {
        try {
            const response = await fetch(`/api/shops/${shopId}/chatbot/enable`, {
                method: 'POST',
                headers: { 'Content-Type': 'application/json' },
                body: JSON.stringify({ enabled: !currentlyEnabled })
            });
            if (!response.ok) throw new Error('Failed to toggle assistant');
            loadAssistants();
        } catch (error) {
            console.error('Error toggling assistant:', error);
            alert('Failed to toggle assistant: ' + error.message);
        }
    }

    function escapeHtml(text) {
        const div = document.createElement('div');
        div.textContent = text;
        return div.innerHTML;
    }

    async function logout() {
        try {
            await fetch('/auth/logout', { method: 'POST' });
        } catch (error) {
            console.error('Logout error:', error);
        }
        window.location.href = '/login.html';
    }

    // Init
    (async function init() {
        await ensureAuth();
        updateContent();
    })();
</script>
</body>
</html>
